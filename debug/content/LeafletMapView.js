define(["require","underscore","jquery","backbone","localizer","personalizer","utils/StringUtil","views/map/MapViewUtils","leaflet","leaflet_draw","leaflet_control_geocoder","constants/map/map","models/user/UserPreference","constants/map/map","lib/MutationObserverPolyfill","views/utils/LeafletMap/MapServices/GoogleAddressService","views/utils/LeafletMap/UILayers/LabelMarker","views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer","views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer0","views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer1","views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer2","views/utils/LeafletMap/RasterLayers/MarineTileLayer","views/utils/LeafletMap/MapProviders/GarminOpenStreetMapProvider","views/utils/LeafletMap/MapProviders/GoogleMapProvider","views/utils/LeafletMap/MapProviders/BingMapProvider","leaflet_google","leaflet_bing","views/utils/LeafletMap/MapProviders/OpenStreetMapProvider","leaflet_garmin_osm","views/utils/LeafletMap/VectorLayers/DraggableCircle","views/utils/LeafletMap/VectorLayers/SelectionRectangle","garminmap"],function(e){var t=e("underscore"),n=e("jquery"),r=e("backbone"),i=e("localizer"),s=e("personalizer"),o=e("utils/StringUtil"),u=e("views/map/MapViewUtils"),a=e("leaflet"),f=e("leaflet_draw"),l=e("leaflet_control_geocoder"),c=e("constants/map/map"),h=e("models/user/UserPreference"),p=e("constants/map/map"),d=e("lib/MutationObserverPolyfill"),v=e("views/utils/LeafletMap/MapServices/GoogleAddressService"),m=e("views/utils/LeafletMap/UILayers/LabelMarker"),g=e("views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer"),y=e("views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer0"),b=e("views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer1"),w=e("views/utils/LeafletMap/RasterLayers/HeatmapMapTileLayer2"),E=e("views/utils/LeafletMap/RasterLayers/MarineTileLayer"),S=e("views/utils/LeafletMap/MapProviders/GarminOpenStreetMapProvider"),x=e("views/utils/LeafletMap/MapProviders/GoogleMapProvider"),T=e("views/utils/LeafletMap/MapProviders/BingMapProvider"),N=e("leaflet_google"),C=e("leaflet_bing"),k=e("views/utils/LeafletMap/MapProviders/OpenStreetMapProvider"),L=e("leaflet_garmin_osm"),A=e("views/utils/LeafletMap/VectorLayers/DraggableCircle"),O=e("views/utils/LeafletMap/VectorLayers/SelectionRectangle"),M=e("garminmap"),_={ON_MAP_READY:"ON_MAP_READY",ON_MAP_PROVIDER_CHANGED:"ON_MAP_PROVIDER_CHANGED",ON_VISIBLE_TILES_LOADED:"ON_VISIBLE_TILES_LOADED"},D={road:"roadmap",satellite:"satellite",terrain:"terrain",hybrid:"hybrid"},P={road:"Road",satellite:"Aerial"},H={MOVE_END:"moveend",DRAG_START:"dragstart",DRAG:"drag",DRAG_END:"dragend"},B=S.TileLayer,j={road:"mapbox.streets",satellite:"mapbox.satellite"},F=r.View.extend({providers:{GOOGLE:"google",BING:"bing",OSM:"osm"},initialize:function(e){e=this.addInitializationDefaults(e),this.initializeState(e)},addInitializationDefaults:function(e){return t.defaults(e,{enableBikeLanes:!0,disablePanning:!1,disableZooming:!1,showControlScale:!0,zoomLimits:{min:3,max:18}})},initializeState:function(e){this.el=e.el,this.viewerIsAuthenticated=e.viewerIsAuthenticated,this.mapContainerId=e.mapContainerId,this.mapContainerClass=e.mapContainerClass,this.enableBikeLanes=e.enableBikeLanes,this.disablePanning=e.disablePanning,this.disableZooming=e.disableZooming,this.showControlScale=e.showControlScale,this.mapProvider=e.mapProvider,this.mapStyle=e.mapStyle,this.zoom=e.zoom,this.zoomLimits=e.zoomLimits,this.mapHasBeenInitialized=!1,this.hideAttributionControl=e.hideAttributionControl},render:function(){return this.$el.attr("id",this.mapContainerId),this.$el.addClass(this.mapContainerClass),this.el},loadMap:function(){u.userInChina()&&u.isMapProviderValid(Garmin.Map.Utils.PROVIDER_TYPE_BAIDU)?this.mapProvider=Garmin.Map.Utils.PROVIDER_TYPE_BAIDU:this.mapProvider===Garmin.Map.Utils.PROVIDER_TYPE_BAIDU&&!u.isMapProviderValid(Garmin.Map.Utils.PROVIDER_TYPE_BAIDU)&&(this.mapProvider="google"),this.mapProvider&&u.isMapProviderValid(this.mapProvider)?this.renderMap():this.viewerIsAuthenticated?this.loadMapProviderPreference():(this.mapProvider="google",this.loadMap()),this.showDefaultZoomControls||this.$(".leaflet-control-zoom").hide()},loadMapProviderPreference:function(){this.mapProviderPreference=new h({key:"map_provider_type"}),this.mapProviderPreference.once("sync",function(){this.mapProvider=this.mapProviderPreference.get("value"),this.mapProvider==null&&(this.mapProvider="google"),this.loadMap()},this),this.mapProviderPreference.fetch()},renderMap:function(){var e=this.getLeafletOptions();if(n("#"+this.mapContainerId).length===0)return;this.map=a.map(this.mapContainerId,e),this.map.attributionControl&&this.map.attributionControl.setPrefix(""),this.configureMap(),this.changeMapStyle(this.mapStyle||"road"),this.mapHasBeenInitialized=!0,this.trigger(_.ON_MAP_READY),this.setupEvents()},getLeafletOptions:function(){var e={};return this.zoomLimits&&(e.minZoom=this.zoomLimits.min),this.hideAttributionControl&&(e.attributionControl=!1),e.zoom=this.zoom,e.worldCopyJump=!0,e},configureMap:function(){this.disableZooming?this.map.scrollWheelZoom.disable():this.map.scrollWheelZoom.enable(),this.disablePanning?this.map.dragging.disable():this.map.dragging.enable(),this.showControlScale&&a.control.scale({position:"bottomright"}).addTo(this.map)},setupEvents:function(){this.currentLayer.on("load",function(){this.trigger(_.ON_VISIBLE_TILES_LOADED)}.bind(this))},changeMapStyle:function(e){if(!e)return;if(this.currentLayer&&e===this.mapStyle)return;return this.currentLayer&&this.map.removeLayer(this.currentLayer),this.mapStyle=e,this.mapProvider===this.providers.GOOGLE?(this.googleLayer=new a.GridLayer.GoogleMutant({type:D[e],maxZoom:this.zoomLimits.max}),this.currentLayer=this.googleLayer,this.map.addLayer(this.googleLayer),this.map.on("layeradd",function(){this.enableBikeLanes&&this.toggleBicycleLayer(!0)}.bind(this))):this.mapProvider===this.providers.BING?(this.currentLayer=new a.BingLayer(c.bingKey,{type:P[e],maxZoom:this.zoomLimits.max}),this.map.addLayer(this.currentLayer)):(this.currentLayer=this.getOpenStreetMapLayer(e),this.map.addLayer(this.currentLayer)),!0},getMapProvider:function(){return this},changeMapProvider:function(e){if(this.mapProvider===e)return;this.mapProvider=e,this.trigger(_.ON_MAP_PROVIDER_CHANGED,e)},zoomIn:function(){this.map.zoomIn(),this._setZoom()},zoomOut:function(){this.map.zoomOut(),this._setZoom()},fitMapToPoints:function(e,n){e&&(t.isArray(e)&&e.length>0||e instanceof a.LatLngBounds)&&this.map.fitBounds(e),n&&n.zoomOutDelta&&this.map.zoomOut(n.zoomOutDelta),this._setZoom()},hasLabelSupport:function(){return this.mapProvider===this.providers.GOOGLE},toggleBicycleLayer:function(e){this.enableBikeLanes=e;if(!this.googleLayer)return;this.enableBikeLanes?this.googleLayer.addGoogleLayer("BicyclingLayer"):this.googleLayer.removeGoogleLayer("BicyclingLayer")},getMapProviderType:function(){return this.mapProvider},hasTerrainSupport:function(){return this.mapProvider===this.providers.GOOGLE},hasTrailSupport:function(){return this.mapProvider===this.providers.GOOGLE},hasHeatmapSupport:function(){return!0},removeMarker:function(e){return this.map.removeLayer(e)},removePolyline:function(e){return this.map.removeLayer(e)},addPolyline:function(e,n){if(e.length<2)return null;var r={};n&&(r.interactive=n.clickable,r.opacity=n.opacity,r.color=n.strokeColor,r.weight=n.width,r.stroke=n.visible),r=t.defaults(r,{interactive:!1,opacity:Garmin.Map.Utils.LINE_OPACITY,color:"#FF0000",weight:Garmin.Map.Utils.LINE_WIDTH,stroke:!0});var i=a.polyline(e,r);return this.map.addLayer(i),i},baiduMapsDisabled:function(){return!0},addMarker:function(e,n,r,i,s,o){var u=a.icon({iconUrl:r.iconURL,iconAnchor:[r.iconAnchor.x,r.iconAnchor.y],iconSize:[r.iconSize.width,r.iconSize.height]}),f={icon:u,zIndexOffset:r.zIndex},l=a.marker([e,n],f);return l.addTo(this.map),i&&t.isFunction(i)&&l.on("click",i),s&&t.isFunction(s)&&l.on("mouseover",s),o&&t.isFunction(o)&&l.on("mouseout",o),l},bindPopupToMarker:function(e,t){var n=a.popup(e).setContent(e.popupText);return t.bindPopup(n),n},addNumberedMarker:function(e,t,n,r){var i=20,s=20,o=a.divIcon({html:'<span class="course-pt course-pt-lap">'+r+"</span>",className:"map-marker",iconAnchor:[Math.floor(s/2),Math.floor(i/2)],iconSize:[s,i]}),u={icon:o,zIndexOffset:n.zIndex},f=a.marker([e,t],u);return f.addTo(this.map),f},removeLayer:function(e){this.map.eachLayer(t.bind(function(t){e(t)&&this.map.removeLayer(t)},this))},setView:function(e,t){var n=u.getStandardizedPoint(e);this.map.setView([n.lat,n.lon],t||this.zoom),this._setZoom()},locate:function(e){this.map.locate(e),this._setZoom()},addLineListener:function(e,t,n){n.on(e,function(e){t({eventPoint:{lat:e.latlng.lat,lon:e.latlng.lng}})})},addMapListener:function(e,t){var n=this.toProprietaryEventName(e);this.map.on(n,t)},enableTerrain:function(e){if(!this.hasTerrainSupport())return;e?this.changeMapStyle("terrain"):this.changeMapStyle("road")},enableTrails:function(e){this.hasTrailSupport()&&this.toggleBicycleLayer(e)},enableLabels:function(e){if(!this.hasLabelSupport())return;e?this.changeMapStyle("hybrid"):this.changeMapStyle("satellite")},enableHeatMaps:function(e,t){if(!this.hasHeatmapSupport())return;this.toggleHeatmapLayersOff(),t=="cycling"?Garmin.Map.Utils.activityType="cycling":Garmin.Map.Utils.activityType="running",e&&this.toggleHeatmapLayersOn()},toggleHeatmapLayersOn:function(){var e=this;this.getHeatMapDependencies().done(function(){var t=Garmin.Map.Utils.heatmapPreferences;t!=null&&(e.map.addLayer(new y("",{tileSize:256,maxZoom:t.heatmapCityZoomLevelEnd,minZoom:t.heatmapGlobalZoomLevelStart,opacity:t.heatmapLayerOpacity,zIndex:2})),e.map.addLayer(new b("",{tileSize:256,maxZoom:t.heatmapCityZoomLevelEnd,minZoom:t.heatmapGlobalZoomLevelStart,opacity:t.heatmapLayerOpacity,zIndex:2})),e.map.addLayer(new w("",{tileSize:256,maxZoom:t.heatmapCityZoomLevelEnd,minZoom:t.heatmapGlobalZoomLevelStart,opacity:t.heatmapLayerOpacity,zIndex:2})))})},getHeatMapDependencies:function(){var e=n.Deferred();return Garmin.Map.Utils.getHeatMapPreferences().done(function(){Garmin.Map.Utils.getAllHeatMapFolderData(Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion).done(function(){e.resolve()})}),e},toggleHeatmapLayersOff:function(){this.removeLayer(function(e){return e instanceof g})},getOpenStreetMapLayer:function(e){return j[e]?B.options.id=j[e]:B.options.id=j.road,new a.GarminOSMLayer(B.url,B.options)},addTilesOverlay:function(e,t){var n=new E(e,t);this.map.addLayer(n),this.map.on("layeradd",function(e){n.bringToFront()})},getMapCenterZoom:function(){return{center:u.getStandardizedPoint(this.map.getCenter()),zoom:this.map.getZoom()}},getTargetZoom:function(){return!1},zoomInMapToUsersLocation:function(e,t,n){this.map.locate({maxZoom:t,setView:!0}).on("locationfound",function(e){this._setZoom(),n&&n(e)}.bind(this))},displayAreaSelectionTool:function(){var e=this.map.latLngToLayerPoint(this.map.getCenter()),t=new a.Point(e.x-100,e.y+100),n=new a.Point(e.x+100,e.y-100),r=new a.latLngBounds(this.map.layerPointToLatLng(t),this.map.layerPointToLatLng(n));return this.selectionRect=(new O(r,{color:"#000",weight:2,opacity:.4,fillColor:"#000",fillOpacity:.4})).addTo(this.map),this.selectionRect},removeAreaSelectionTool:function(){this.selectionRect&&(this.map.off("mouseup"),this.selectionRect.off("mousedown"),this.map.off("mousemove"),this.map.removeLayer(this.selectionRect),delete this.selectionRect)},searchForLocation:function(e,t){var n=new a.Control.Geocoder.Bing(p.bingKey);n.geocode(e,function(e){var n=null;e.length!==0&&(n=e[0],this.fitMapToPoints(n.bbox),t&&t(n,e))},this)},searchAddressByPosition:function(e,t){var n=new v;n.fetch({location:[e.lat,e.lng],success:function(e){t(e.address)},error:function(){t()}},this)},displayPrivacyZone:function(e,t,n,r){var i=this.displayCircleAndMarkersToMap(t,r);this.panPointToMap(i.circle)},displayCircleAndMarkersToMap:function(e,t,n){var r=(new A([e.center.lat,e.center.lng],e.radius,{weight:e.strokeWeight,fillColor:e.fillColor,fillOpacity:e.fillOpacity,draggable:e.draggable})).addTo(this.map),i=t.icon,s=a.icon({iconUrl:i.url,iconSize:a.point(i.scaledSize,i.scaledSize),iconAnchor:a.point(i.anchor,i.anchor)}),o=(new m([t.position.lat,t.position.lng],{icon:s,draggable:t.draggable})).addTo(this.map),u={circle:r,marker:o};if(n){var f=a.divIcon({html:n.label.text,className:"privacy-zone-map-radius-label",iconSize:[n.leafletIcon.width,0],iconAnchor:a.point(n.leafletIcon.anchor.x,n.leafletIcon.anchor.y)}),l=(new m([t.position.lat,t.position.lng],{icon:f,draggable:e.draggable})).addTo(this.map);u.labelMarker=l}return u},panPointToMap:function(e){var t=e.getBounds(),n=[];n.push([t.getSouthWest().lat,t.getSouthWest().lng]),n.push([t.getNorthEast().lat,t.getNorthEast().lng]),this.fitMapToPoints(n)},toProprietaryEventName:function(e){var t=e;switch(e){case Garmin.Map.Utils.EVENT_DRAG_START:t=H.DRAG_START;break;case Garmin.Map.Utils.EVENT_DRAGGING:t=H.DRAG;break;case Garmin.Map.Utils.EVENT_DRAG_END:t=H.DRAG_END;break;case Garmin.Map.Utils.EVENT_MAP_VIEW_CHANGE_END:t=H.MOVE_END;break;default:t=e}return t},displayPrivacyZoneMap:function(e,t,n,r,i,s,o,u,a){var f=this.displayCircleAndMarkersToMap(t,r,s);a.zoneCircle=f.circle,a.zoneCircle.marker=f.marker,a.zoneCircle.labelMarker=f.labelMarker,a.zoneCircle.on(o,a.onCircleDragHandler.bind(a)),a.zoneCircle.marker.on(o,a.onMarkerDragHandler.bind(a)),a.zoneCircle.labelMarker.on(o,a.onLabelDragHandler.bind(a)),a.zoneCircle.on(u,a.updateAddressBar.bind(a)),a.zoneCircle.marker.on(u,a.updateAddressBar.bind(a)),a.zoneCircle.labelMarker.on(u,a.updateAddressBar.bind(a)),this.panPointToMap(a.zoneCircle)},formatPointAsObject:function(e){return e},getDraggingEventPoint:function(e){return e.target.getLatLng()},getEventPoint:function(e){return e.latlng},getMapPoint:function(e){return e},getLocationPoint:function(e){return e.center},_setZoom:function(){this.zoom=this.map.getZoom()},resizeMap:function(){this.map.invalidateSize()},changeCursorStyle:function(e){this.$el.css("cursor",e)}});return F});