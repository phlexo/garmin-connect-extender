define("widgets/calendar/states/SmallState",["underscore","backbone","views/main/WidgetStateView","utils/NavigationUtil","text!templates/main/Widget/SmallWidgetContent.html"],function(e,t,n,r,i){var s=n.extend({titleKeyName:"title_calendar_widget",menuKeyName:"title_widget_small",name:"calendarSmall",stateClassName:"widget widget-small",templateHtml:i,noDataTemplateHtml:i,showFooter:!1,showHeaderTitle:!1,headerUrl:"/calendar",menuGroups:[],maxPage:function(){return 0},numLoadedPages:function(){return 1},provideModels:function(){return{classIconName:"icon-calendar"}}});return s}),define("events/CalDispatcher",["underscore","backbone"],function(e,t){var n={DAY_CLICKED:"DAY_CLICKED",ITEM_MOVED:"ITEM_MOVED",ITEM_DROPPED:"ITEM_DROPPED",MONTHLY_TOTALS_UPDATED:"MONTHLY_TOTALS_UPDATED",CALENDAR_MODEL_FETCHED:"CALENDAR_MODEL_FETCHED",GOALS_UPDATED:"GOALS_UPDATED",CALENDAR_ITEM_REMOVED:"CALENDAR_ITEM_REMOVED",CALENDAR_ITEM_ADDED:"CALENDAR_ITEM_ADDED",CALENDAR_ITEM_INVALIDATED:"CALENDAR_ITEM_INVALIDATED",CALENDAR_ITEM_EDIT:"CALENDAR_ITEM_EDIT",ACTIVITY_UPDATED:"ACTIVITY_UPDATED",WEIGHT_CHANGE:"WEIGHT_CHANGE",MAIN_VIEW_RENDERED:"MAIN_VIEW_RENDERED",ADD_FORM_RENDERED:"ADD_FORM_RENDERED"},r=e.clone(t.Events);return r.Events=n,r}),define("models/calendar/CalendarItem",["backbone","events/CalDispatcher"],function(e,t){var n=e.Model.extend({idAttribute:["itemType","id","isStart","date"],initialize:function(){this.backup(),this.bind("change:date",this.onChange,this),this.bind("sync",this.onSync,this),this.bind("error",this.onError,this)},defaults:{isStart:null},backup:function(){this.backupAttributes=_.clone(this.attributes),this.isDirty=!1},restore:function(){this.backupAttributes&&(this.set(this.backupAttributes,{silent:!0}),this.isDirty=!1)},onSync:function(){this.get("itemType")=="activity"?(t.trigger(t.Events.ACTIVITY_UPDATED,this.backupAttributes,this.attributes),t.trigger(t.Events.GOALS_UPDATED)):t.trigger(t.Events.ITEM_MOVED,this.backupAttributes.date,this.get("date")),this.backup()},onError:function(){this.restore(),t.trigger(t.Events.ITEM_MOVED,this.previous("date"),this.get("date"))},onChange:function(){this.isDirty=!0},url:function(){return this.get("groupId")?"/proxy/calendar-service/calendarItem/group/"+this.get("groupId")+"/"+this.get("itemType")+"/"+this.get("id")+"/date/"+this.get("date"):"/proxy/calendar-service/calendarItem/"+this.get("itemType")+"/"+this.get("id")+"/date/"+this.get("date")},destroy:function(){if(this.get("itemType")=="goal"){var e=_.clone(this);e.set("isStart",!this.get("isStart")),e.trigger("destroy",e)}this.trigger("destroy",this)}});return n}),define("collections/calendar/CalendarItems",["backbone","models/calendar/CalendarItem"],function(e,t){var n=e.Collection.extend({model:t,getItemForDate:function(e){return _.filter(this.models,function(t){return t.get("date")==e})}});return n}),define("models/calendar/CalendarUpcoming",["backbone","collections/calendar/CalendarItems"],function(e,t){var n=e.Model.extend({url:function(){return this.groupId?"/proxy/calendar-service/upcomingevents/group/"+this.groupId+"/year/"+this.year+"/month/"+this.month+"/day/"+this.day+"/days/"+this.days:"/proxy/calendar-service/upcomingevents/year/"+this.year+"/month/"+this.month+"/day/"+this.day+"/days/"+this.days},initialize:function(e){this.year=e.year,this.month=e.month,this.day=e.day,this.days=e.days,this.groupId=e.groupId},parse:function(e){return e.calendarItems&&(e.calendarItems=new t(e.calendarItems)),e}});return n}),define("text!widgets/calendar/templates/dayItemView.html",[],function(){return'<% if(upcomingItem) { %>\n\n<div class=\'calendar-item\'  style=\'background-color:<%= itemColor %>\'><i class=\'<%= itemClass %>\'></i><a href=\'#\' class=\'item-content\'>"<%= itemTitle %>"</a></div>\n\n<% } else if(weekDay) { %>\n\n<a href="#" class="calendar-item has-tooltip" style="background-color:<%= itemColor %>" title="<%= itemTitle %>"><i class="<%= itemClass %>"></i></a>\n\n<% } else if(monthDay) { %>\n\n<a href="#" class="calendar-item has-tooltip" style="background-color:<%= itemColor %>" title="<%= itemTitle %>"></a>\n\n<% } %>\n'}),define("widgets/calendar/views/UpcomingDayView",["underscore","backbone","localizer","personalizer","utils/CalendarUtil","utils/ItemTypeIconClassMapper","utils/NavigationUtil","models/calendar/UserCalendarPreferences","text!widgets/calendar/templates/dayItemView.html"],function(e,t,n,r,i,s,o,u,a){var f=t.View.extend({events:{"click .calendar-item":"onEventClicked"},initialize:function(e){if(typeof e.model=="undefined")throw"model required for calendar DayView.";this.items=e.model,this.currDay=e.currDay,this.userCalendarPreferences=e.userCalendarPreferences?e.userCalendarPreferences.toJSON():null,this.activityTypes=e.activityTypes,this.itemCount=e.itemCount,this.dayCount=e.dayCount},getItemCount:function(){return this.itemCount},getDayCount:function(){return this.dayCount},render:function(){this.includeItems=i.getIncludedItems(this.items);var t=0,r=this,o,u=this.determineVisibleItems();if(this.includeItems&&this.includeItems.length>0&&u){var f=new Date;this.$el.append(this.buildDateEntryHeader(this.currDay,f)),o=this.$("#dayPlaceholder_"+this.currDay.getFullYear()+(this.currDay.getMonth()+1)+this.currDay.getDate()),this.dayCount++,e.each(this.includeItems,function(t){var u=e.template(a);if(r.itemCount<11&&i.getItemVisibility(t,r.activityTypes,r.userCalendarPreferences)){var f=t.get("title")?t.get("title"):n.localize("untitled"),l="#"+i.getItemColor(t,r.activityTypes,r.userCalendarPreferences),c=s.getItemIconClass(t,r.activityTypes),h=u({Localizer:n,itemTitle:f,itemColor:l,itemClass:c,monthDay:!1,upcomingItem:!0,weekDay:!1});o.append(h),r.itemCount++}})}return this.el},determineVisibleItems:function(){var t=!1,n=this;return e.each(this.includeItems,function(e){i.getItemVisibility(e,n.activityTypes,n.userCalendarPreferences)&&(t=!0)}),t},buildDateEntryHeader:function(e,t){var n="";e.getFullYear()==t.getFullYear()&&e.getMonth()==t.getMonth()&&e.getDate()==t.getDate()&&(n="current-day");var r="<div class='calendar-data "+n+"'>";return r+="<div class='day-header'>"+i.localizeDayFromDate(e)+"</div>",r+="<div id='dayPlaceholder_"+e.getFullYear()+(e.getMonth()+1)+e.getDate()+"' class='day-data'></div>",r+="</div>",r},onEventClicked:function(e){e.preventDefault(),o.navigate("/calendar/"+this.currDay.getFullYear()+"/"+this.currDay.getMonth())}});return f}),define("text!widgets/calendar/templates/upcomingItems.html",[],function(){return'<div class="calendar-list">\n    <div class="calendar-header"><%= Localizer.localize(\'upcoming.items\') %></div>\n    <div class="calendar-body">\n    </div>\n</div>\n\n\n\n'}),define("widgets/calendar/states/UpcomingItemsState",["underscore","backbone","localizer","personalizer","collections/calendar/CalendarItems","collections/activity/ActivityTypes","models/calendar/CalendarUpcoming","models/calendar/UserCalendarPreferences","utils/date/DateUtil","utils/CalendarUtil","utils/ModelSynchronizer","views/main/WidgetStateView","widgets/calendar/views/UpcomingDayView","text!widgets/calendar/templates/upcomingItems.html"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){return c.extend({titleKeyName:"title_calendar_widget",menuKeyName:"title_calendar_widget_items_view",headerUrl:"/calendar",name:"calendarUpcomingView",stateClassName:"widget-large calendar calendar-week",templateHtml:p,noDataTemplateHtml:p,showFooter:!1,initializeWidgetState:function(){this.selectedDate=new Date,this.selectedDate.setDate(this.selectedDate.getDate()-1),this.activityTypes=new s([]),this.userCalendarPreferences=new u,this.groupModels=[],this.dependenciesLoaded=!1},maxPage:function(){return 1},numLoadedPages:function(){return 1},provideDependencies:function(e){e.addModel({model:this.activityTypes,required:!0}),e.addModel({model:this.userCalendarPreferences,required:!0})},provideModels:function(e){return{Localizer:n}},onDependenciesLoaded:function(){this.dependenciesLoaded=!0,this.postRender()},postRender:function(){if(this.dependenciesLoaded){var t=new l;this.calendarUpcoming=new o({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),day:this.selectedDate.getDate(),days:365,groupId:null}),t.addModel({model:this.calendarUpcoming,required:!0}),this.groupModels=[],e.each(this.userCalendarPreferences.get("groups"),function(e){if(e.show){var n=new o({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),day:this.selectedDate.getDate(),days:365,groupId:e.id});t.addModel({model:n,required:!0}),this.groupModels.push(n)}},this),t.bind(l.Events.SYNCHRONIZED,this.onReadyToRender,this),t.bind(l.Events.SYNCHRONIZE_FAILED,this.widgetView.onDependenciesLoadFailed,this.widgetView),t.fetchModels()}},onReadyToRender:function(){this.calendarUpcoming&&this.calendarUpcoming.get("calendarItems")&&(e.each(this.groupModels,function(e){var t=e.get("calendarItems");t&&this.calendarUpcoming.get("calendarItems").add(t.models)},this),this.loadCalendar())},loadCalendar:function(){var e=this.$(".calendar-body");e.empty();var t=a.getDateFromISODateString(this.calendarUpcoming.get("startDate")),r=0,i=0;for(var s=0;i<11&&r<7&&s<365;s++){var o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),u=f.getDayItems(this.calendarUpcoming.get("calendarItems"),o);if(u&&u.length>0){var l=new h({currDay:o,model:u,itemCount:i,dayCount:r,userCalendarPreferences:this.userCalendarPreferences,activityTypes:this.activityTypes});e.append(l.render()),i=l.getItemCount(),r=l.getDayCount()}t.setDate(t.getDate()+1)}r==0&&e.append("<p>"+n.localize("upcoming.items.no.data")+"</p>")},formatFooter:function(){}})}),define("models/calendar/CalendarWeek",["backbone","collections/calendar/CalendarItems"],function(e,t){var n=e.Model.extend({url:function(){return this.groupId?"/proxy/calendar-service/group/"+this.groupId+"/year/"+this.year+"/month/"+this.month+"/day/"+this.day+"/start/"+this.firstDayOfWeek:"/proxy/calendar-service/year/"+this.year+"/month/"+this.month+"/day/"+this.day+"/start/"+this.firstDayOfWeek},initialize:function(e){this.year=e.year,this.month=e.month,this.day=e.day,this.firstDayOfWeek=e.firstDayOfWeek,this.groupId=e.groupId},parse:function(e){return this.calendarItems=new t(e.calendarItems),e}});return n}),define("widgets/calendar/views/WeekDayView",["underscore","backbone","localizer","personalizer","utils/date/DateUtil","utils/CalendarUtil","utils/ItemTypeIconClassMapper","utils/NavigationUtil","models/calendar/UserCalendarPreferences","text!widgets/calendar/templates/dayItemView.html"],function(e,t,n,r,i,s,o,u,a,f){var l=t.View.extend({events:{"click .calendar-item":"onEventClicked"},initialize:function(t){if(typeof t.model=="undefined")throw"model required for calendar DayView.";this.items=t.model,this.currDay=t.currDay,this.userCalendarPreferences=t.userCalendarPreferences?t.userCalendarPreferences.toJSON():null,this.activityTypes=t.activityTypes,this.template=e.template(f)},render:function(){this.includeItems=s.getIncludedItems(this.items);var t=this,r=0,i=this.getVisibleItems(this.includeItems),u=5;e.each(i,function(e,a){if(a<u-1||i.length===u){var f=e.get("itemType");if(!f)return;var l=e.get("title")?e.get("title"):n.localize("untitled"),c="#"+s.getItemColor(e,t.activityTypes,t.userCalendarPreferences),h=o.getItemIconClass(e,t.activityTypes),p=t.template({Localizer:n,itemTitle:l,itemColor:c,itemClass:h,monthDay:!1,upcomingItem:!1,weekDay:!0});t.$el.append(p)}else r++});if(r>0){var a="+"+r;this.$el.append("<a href='#' class='calendar-item item-more colored'>"+a+"</a>")}return this.el},onEventClicked:function(e){e.preventDefault(),u.navigate("/calendar/"+this.currDay.getFullYear()+"/"+this.currDay.getMonth())},getVisibleItems:function(t){return e.filter(t,function(e){return s.getItemVisibility(e,this.activityTypes,this.userCalendarPreferences)},this)}});return l}),define("text!widgets/calendar/templates/weekView.html",[],function(){return'<div class="calendar-list calendar-list-avatars">\n    <div class="calendar-header calendar-week-range">\n        <span class="js-calendar-date-range"></span>\n    </div>\n    <div class="calendar-body">\n\n        <% var day = firstDayOfWeek;\n        for(var d=0; d<7; d++) { %>\n            <div class="calendar-data <%= getCalendarDayClass(day) %>">\n                <div class="day-header"><%= localizeDay(day++, selectedDate) %></div>\n                <div id="dayPlaceholder_<%= d %>" class="day-data"></div>\n            </div>\n        <% } %>\n\n    </div>\n</div>\n'}),define("widgets/calendar/states/WeekViewState",["require","underscore","backbone","localizer","personalizer","collections/calendar/CalendarItems","collections/activity/ActivityTypes","models/calendar/CalendarWeek","models/user/UserPreferences","models/calendar/UserCalendarPreferences","utils/date/DateUtil","utils/CalendarUtil","utils/ModelSynchronizer","utils/ToolTipUtil","views/main/WidgetStateView","widgets/calendar/views/WeekDayView","text!widgets/calendar/templates/weekView.html","jquerymenus"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("personalizer"),s=e("collections/calendar/CalendarItems"),o=e("collections/activity/ActivityTypes"),u=e("models/calendar/CalendarWeek"),a=e("models/user/UserPreferences"),f=e("models/calendar/UserCalendarPreferences"),l=e("utils/date/DateUtil"),c=e("utils/CalendarUtil"),h=e("utils/ModelSynchronizer"),p=e("utils/ToolTipUtil"),d=e("views/main/WidgetStateView"),v=e("widgets/calendar/views/WeekDayView"),m=e("text!widgets/calendar/templates/weekView.html"),g=e("jquerymenus");return d.extend({titleKeyName:"title_calendar_widget",menuKeyName:"title_calendar_widget_week_view",headerUrl:function(){return this.selectedDate?"/calendar/"+this.selectedDate.getFullYear()+"/"+this.selectedDate.getMonth():"/calendar"},name:"calendarWeekView",stateClassName:"widget-large calendar calendar-week",templateHtml:m,noDataTemplateHtml:m,navigationDirection:"both",initializeWidgetState:function(){this.selectedDate=new Date,this.activityTypes=new o([]),this.userCalendarPreferences=new f,this.groupModels=[],this.firstDayOfWeek=this.userPreferences.get("firstDayOfWeek").dayId-2,this.firstDayOfWeek<0&&(this.firstDayOfWeek+=7),this.dependenciesLoaded=!1},maxPage:function(){return 0},numLoadedPages:function(){return Infinity},provideDependencies:function(e){e.addModel({model:this.activityTypes,required:!0}),e.addModel({model:this.userCalendarPreferences,required:!0})},processNavigationDirection:function(e,t){t=="PAGE_PREVIOUS"?this.selectedDate.setDate(this.selectedDate.getDate()-7):t=="PAGE_NEXT"&&this.selectedDate.setDate(this.selectedDate.getDate()+7)},provideModels:function(e){return{firstDayOfWeek:this.firstDayOfWeek,localizeDay:c.localizeDay,selectedDate:this.selectedDate,getCalendarDayClass:c.getCalendarDayClass}},onDependenciesLoaded:function(){this.dependenciesLoaded=!0,this.postRender()},postRender:function(){if(this.dependenciesLoaded){var e=new h;this.calendarWeek=new u({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),day:this.selectedDate.getDate(),firstDayOfWeek:this.firstDayOfWeek,groupId:null}),e.addModel({model:this.calendarWeek,required:!0}),this.groupModels=[],t.each(this.userCalendarPreferences.get("groups"),function(t){if(t.show){var n=new u({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),day:this.selectedDate.getDate(),firstDayOfWeek:this.firstDayOfWeek,groupId:t.id});e.addModel({model:n,required:!0}),this.groupModels.push(n)}},this),e.bind(h.Events.SYNCHRONIZED,this.onReadyToRender,this),e.bind(h.Events.SYNCHRONIZE_FAILED,this.widgetView.onDependenciesLoadFailed,this.widgetView),e.fetchModels()}},onReadyToRender:function(){this.calendarWeek&&this.calendarWeek.calendarItems&&(t.each(this.groupModels,function(e){var t=e.get("calendarItems");t&&this.calendarWeek.calendarItems.add(t.models)},this),this.loadCalendar())},loadCalendar:function(){this.setCalendarHeader();var e,t=l.getDateFromISODateString(this.calendarWeek.get("startDate"));for(var n=0;n<7;n++){var r="dayPlaceholder_"+n;e=this.$("#"+r),e.empty();var i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=c.getDayItems(this.calendarWeek.calendarItems,i),o=new v({currDay:i,model:s,userCalendarPreferences:this.userCalendarPreferences,activityTypes:this.activityTypes});e.append(o.render()),t.setDate(t.getDate()+1)}p.renderTooltips.call(this)},setCalendarHeader:function(){this.startDate=l.getDateFromISODateString(this.calendarWeek.get("startDate")),this.endDate=l.getDateFromISODateString(this.calendarWeek.get("endDate"));var e="";this.startDate.getFullYear()==this.endDate.getFullYear()?r.currentDateFormatKey=="yyyymmdd"?e=r.formatShortDate(this.startDate,null)+" - "+r.formatShortDateNoYear(this.endDate,null):e=r.formatShortDateNoYear(this.startDate,null)+" - "+r.formatShortDate(this.endDate,null):e=r.formatShortDate(this.startDate,null)+" - "+r.formatShortDate(this.endDate,null),jQuery(".js-calendar-date-range").html(e)},formatFooter:function(){}})}),define("models/calendar/CalendarMonth",["backbone","collections/calendar/CalendarItems"],function(e,t){var n=e.Model.extend({url:function(){return this.groupId?"/proxy/calendar-service/group/"+this.groupId+"/year/"+this.year+"/month/"+this.month:"/proxy/calendar-service/year/"+this.year+"/month/"+this.month},initialize:function(e){this.month=e.month,this.year=e.year,this.groupId=e.groupId,this.isDirty=!1,this.bind("change",this.onChange,this),this.bind("sync",this.onSync,this)},backup:function(){this.backupAttributes=_.clone(this.attributes)},restore:function(){this.backupAttributes&&(this.set(this.backupAttributes),this.isDirty=!1)},onSync:function(){this.isDirty=!1,this.backup()},onChange:function(){this.isDirty=!0},getYear:function(){return this.year},getMonth:function(){return this.month},parse:function(e){if(e.calendarItems){var r=[],i;for(i=0;i<e.calendarItems.length;i+=1)r.push(new n(e.calendarItems[i]));e.calendarItems=new t(r)}return e}});return n}),define("text!widgets/calendar/templates/monthDayView.html",[],function(){return"<td id='<%= dayOfMonth %>' class='calendar-data <%= dateClass %>' >\n    <span class=\"day-number\"><%= dayOfMonth %></span>\n</td>\n\n"}),define("widgets/calendar/views/MonthDayView",["underscore","backbone","localizer","personalizer","utils/CalendarUtil","utils/BadgeUtil","utils/NavigationUtil","utils/activity/ActivitiesUtil","models/calendar/UserCalendarPreferences","text!widgets/calendar/templates/monthDayView.html","text!widgets/calendar/templates/dayItemView.html"],function(e,t,n,r,i,s,o,u,a,f,l){var c=t.View.extend({events:{"click .calendar-item":"onEventClicked"},initialize:function(e){if(typeof e.model=="undefined")throw"model required for calendar DayView.";this.items=e.model,this.currDay=e.currDay,this.outsideCurrentDate=e.outsideCurrentDate,this.userCalendarPreferences=e.userCalendarPreferences?e.userCalendarPreferences.toJSON():null,this.activityTypes=e.activityTypes},render:function(){var t=e.template(f),r=t({dayOfMonth:this.currDay.getDate(),dateClass:i.getDateRelClass(this.currDay,this.outsideCurrentDate)});this.setElement(jQuery(r)),this.includeItems=i.getIncludedItems(this.items);var s=0,o=this,u=0;e.each(this.includeItems,function(t){var r=e.template(l);if(i.getItemVisibility(t,o.activityTypes,o.userCalendarPreferences))if(s<2){var a=o.getItemTitle(t,o.activityTypes),f="#"+i.getItemColor(t,o.activityTypes,o.userCalendarPreferences),c="",h=r({Localizer:n,itemTitle:a,itemColor:f,itemClass:c,monthDay:!0,upcomingItem:!1,weekDay:!1});o.$el.append(h),s++}else u++});if(u>0){var a="+"+u;this.$el.append("<a href='#' class='calendar-item item-more colored'>"+a+"</a>")}return this.el},getItemTitle:function(e,t){var r=e.get("title")||n.localize("untitled"),i=e.get("activityTypeId")?t.idMap[e.get("activityTypeId")].get("typeKey"):null;return e.get("itemType")==="badge"?r=s.getBadgeTitleFromCalendarItem(e):e.get("itemType")==="activity"&&u.isDivingActivity(i)&&typeof e.get("diveNumber")!="undefined"&&e.get("diveNumber")!==null&&(r=n.localize("dive_number_label")+" "+e.get("diveNumber")+": "+r),r},onEventClicked:function(e){e.preventDefault(),o.navigate("/calendar/"+this.currDay.getFullYear()+"/"+this.currDay.getMonth())}});return c}),define("text!widgets/calendar/templates/monthView.html",[],function(){return'<div class="calendar-header">\n    <span class="month"><%= Localizer.localize(\'month.\'+month) %></span> <span class="year"><%= year %></span>\n</div>\n<div class="calendar-body">\n    <table class="calendar-table">\n        <tbody class="calendar-year-month-table-body">\n            <tr class="calendar-table-header">\n                <% var day = firstDayOfWeek;\n                for(var d=0; d<7; d++) { %>\n                <th><%= localizeDay(day++) %></th>\n                <% } %>\n            </tr>\n            <tr id="yearMonthWeekPlaceholder_0"></tr>\n            <tr id="yearMonthWeekPlaceholder_1"></tr>\n            <tr id="yearMonthWeekPlaceholder_2"></tr>\n            <tr id="yearMonthWeekPlaceholder_3"></tr>\n            <tr id="yearMonthWeekPlaceholder_4"></tr>\n            <tr id="yearMonthWeekPlaceholder_5"></tr>\n        </tbody>\n    </table>\n</div>\n'}),define("widgets/calendar/states/MonthViewState",["require","underscore","backbone","localizer","personalizer","collections/calendar/CalendarItems","collections/activity/ActivityTypes","models/calendar/CalendarMonth","models/user/UserPreferences","models/calendar/UserCalendarPreferences","utils/date/DateUtil","utils/CalendarUtil","utils/ModelSynchronizer","utils/ToolTipUtil","views/main/WidgetStateView","widgets/calendar/views/MonthDayView","text!widgets/calendar/templates/monthView.html","jquerymenus"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("personalizer"),s=e("collections/calendar/CalendarItems"),o=e("collections/activity/ActivityTypes"),u=e("models/calendar/CalendarMonth"),a=e("models/user/UserPreferences"),f=e("models/calendar/UserCalendarPreferences"),l=e("utils/date/DateUtil"),c=e("utils/CalendarUtil"),h=e("utils/ModelSynchronizer"),p=e("utils/ToolTipUtil"),d=e("views/main/WidgetStateView"),v=e("widgets/calendar/views/MonthDayView"),m=e("text!widgets/calendar/templates/monthView.html"),g=e("jquerymenus");return d.extend({titleKeyName:"title_calendar_widget",menuKeyName:"title_calendar_widget_month_view",headerUrl:function(){return this.selectedDate?"/calendar/"+this.selectedDate.getFullYear()+"/"+this.selectedDate.getMonth():"/calendar"},name:"calendarMonthView",stateClassName:"widget-large calendar calendar-month",templateHtml:m,noDataTemplateHtml:m,navigationDirection:"both",initializeWidgetState:function(){this.selectedDate=new Date,this.activityTypes=new o([]),this.userCalendarPreferences=new f,this.groupModels=[],this.firstDayOfWeek=this.userPreferences.get("firstDayOfWeek").dayId-2,this.firstDayOfWeek<0&&(this.firstDayOfWeek+=7),this.dependenciesLoaded=!1},maxPage:function(){return 0},numLoadedPages:function(){return Infinity},provideDependencies:function(e){e.addModel({model:this.activityTypes,required:!0}),e.addModel({model:this.userCalendarPreferences,required:!0})},processNavigationDirection:function(e,t){t=="PAGE_PREVIOUS"?l.subtractMonth(this.selectedDate):t=="PAGE_NEXT"&&l.addMonth(this.selectedDate)},provideModels:function(e){var t=this.selectedDate.getMonth()+1;return{year:this.selectedDate.getFullYear(),month:t>9?t:"0"+t,firstDayOfWeek:this.firstDayOfWeek,localizeDay:this.localizeDay}},onDependenciesLoaded:function(){this.dependenciesLoaded=!0,this.postRender()},postRender:function(){if(this.dependenciesLoaded){var e=new h;this.calendarMonth=new u({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),groupId:null}),e.addModel({model:this.calendarMonth,required:!0}),this.groupModels=[],t.each(this.userCalendarPreferences.get("groups"),function(t){if(t.show){var n=new u({year:this.selectedDate.getFullYear(),month:this.selectedDate.getMonth(),groupId:t.id});e.addModel({model:n,required:!0}),this.groupModels.push(n)}},this),e.bind(h.Events.SYNCHRONIZED,this.onReadyToRender,this),e.bind(h.Events.SYNCHRONIZE_FAILED,this.widgetView.onDependenciesLoadFailed,this.widgetView),e.fetchModels()}},onReadyToRender:function(){t.each(this.groupModels,function(e){var t=e.get("calendarItems");t&&this.calendarMonth.get("calendarItems")&&this.calendarMonth.get("calendarItems").add(t.models)},this),this.loadCalendar()},loadCalendar:function(){var e=1,t=0,n,r;this.numDaysInMonth=this.calendarMonth.get("numOfDaysInMonth"),this.numDaysInPrevMonth=this.calendarMonth.get("numOfDaysInPrevMonth"),this.year=this.calendarMonth.get("year"),this.month=this.calendarMonth.get("month"),this.firstWeekdayOfMonth=(new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth(),1)).getDay();for(var i=0;i<7&&e<=this.numDaysInMonth;i++){var s="yearMonthWeekPlaceholder_"+i;r=this.$("#"+s),r.empty();if(i==0&&this.firstWeekdayOfMonth!=this.firstDayOfWeek){var o=this.firstWeekdayOfMonth-this.firstDayOfWeek;o<0&&(o+=7);var u=this.month-1,a=this.year;u<0&&(u=11,a--);for(var f=this.numDaysInPrevMonth-o;t<o;t++){n=new Date(a,u,++f);var l=c.getDayItems(this.calendarMonth.get("calendarItems"),n),h=new v({currDay:n,model:l,userCalendarPreferences:this.userCalendarPreferences,activityTypes:this.activityTypes,outsideCurrentDate:!0});r.append(jQuery(h.render()))}}for(;e<=this.numDaysInMonth;e++){n=new Date(this.year,this.month,e);var l=c.getDayItems(this.calendarMonth.get("calendarItems"),n),h=new v({currDay:n,model:l,userCalendarPreferences:this.userCalendarPreferences,activityTypes:this.activityTypes,outsideCurrentDate:!1});r.append(h.render());if(++t==7){t=0,e++;break}}if(t>0&&t<7){var d=this.month+1,m=this.year;d>11&&(d=0,m++);for(var f=1;t<7;t++){n=new Date(m,d,f++);var l=c.getDayItems(this.calendarMonth.get("calendarItems"),n),h=new v({currDay:n,model:l,userCalendarPreferences:this.userCalendarPreferences,activityTypes:this.activityTypes,outsideCurrentDate:!0});r.append(jQuery(h.render()))}}}p.renderTooltips.call(this)},formatFooter:function(){var e=this.selectedDate.getMonth()+1;return r.localize("month."+(e>9?e:"0"+e))+" "+this.selectedDate.getFullYear()},localizeDay:function(e){return e>6&&(e-=7),r.localize("day."+e+".abbr")}})}),define("models/office_integration/Office365Takeover",["require","backbone"],function(e){var t=e("backbone"),n=t.Model.extend({initialize:function(e){this.url="/proxy/calendar-service/calendarSync/office365/takeoverStatus"},save:function(e,n,r){return this.url="/proxy/calendar-service/calendarSync/office365/takeoverViewed",t.Model.prototype.save.call(this,e,n,r)},parse:function(e){return this.takeoverStatus=e,e}});return n}),define("text!widgets/calendar/templates/officeTakeover.html",[],function(){return'<div class="widget-takeover-details top-xl">\n    <div class="item-block">\n		<i class="icon-calendar"></i>\n	</div>\n\n    <div class="connections-title-container">\n        <h3 class="font-thin" title="<%= Localizer.localize(\'office_takeover\') %>"><%= Localizer.localize(\'office_takeover\') %></h3>\n    </div>\n\n    <button class="btn top-s connect-third-party-sharing js-connect-office"><%= Localizer.localize(\'office_connect\') %></button>\n</div>\n\n<div class="widget-takeover-decoration"></div>\n\n<div class="widget-takeover-dismiss center-x-parent">\n    <div class="center-x-child">\n        <a href="#" class="js-dismiss-takeover"><%= Localizer.localize(\'office_dismiss\') %></a>\n    </div>\n</div>'}),define("widgets/calendar/views/OfficeTakeover",["require","underscore","backbone","localizer","text!widgets/calendar/templates/officeTakeover.html"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("text!widgets/calendar/templates/officeTakeover.html"),s={DISMISS_TAKEOVER:"DISMISS_TAKEOVER",CONNECT:"CONNECT"},o=n.View.extend({events:{"click .js-dismiss-takeover":"onDismissTakeoverClicked","click .js-connect-office":"onConnectOfficeClicked"},initialize:function(e){this.template=t.template(i)},render:function(){var e=this.template({Localizer:r});return this.$el.html(e),this.el},onConnectOfficeClicked:function(e){e.preventDefault(),this.trigger(s.CONNECT)},onDismissTakeoverClicked:function(e){e.preventDefault(),this.trigger(s.DISMISS_TAKEOVER)}});return o.Events=s,o}),define("utils/office365/MessageSheetView",["require","underscore","backbone","localizer"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=n.View.extend({className:"widget-sheet-content-inner",initialize:function(e){this.messageObj=e.messageObj},render:function(){var e=$("<div></div>").addClass("alert alert-"+this.messageObj.status).text(this.messageObj.message);this.$el.html(e)}});return i}),define("widgets/calendar/Calendar",["require","backbone","views/main/WidgetView","widgets/calendar/states/SmallState","widgets/calendar/states/UpcomingItemsState","widgets/calendar/states/WeekViewState","widgets/calendar/states/MonthViewState","utils/Office365Auth","models/office_integration/Office365Takeover","widgets/calendar/views/OfficeTakeover","utils/office365/MessageSheetView"],function(e){var t=e("backbone"),n=e("views/main/WidgetView"),r=e("widgets/calendar/states/SmallState"),i=e("widgets/calendar/states/UpcomingItemsState"),s=e("widgets/calendar/states/WeekViewState"),o=e("widgets/calendar/states/MonthViewState"),u=e("utils/Office365Auth"),a=e("models/office_integration/Office365Takeover"),f=e("widgets/calendar/views/OfficeTakeover"),l=e("utils/office365/MessageSheetView"),c=n.extend({viewStates:[{name:"large-state",views:[{name:"calendarUpcomingView",widgetStateView:i},{name:"calendarWeekView",widgetStateView:s},{name:"calendarMonthView",widgetStateView:o}]},{name:"small-state",views:[{name:"calendarSmall",widgetStateView:r}]}],propertyFiles:["/main/js/properties/calendar/calendar","/main/js/properties/userprofile/userprofile","/main/js/properties/badges/badges"],menuGroups:[{groupName:"office365Menu",menuItems:[]}],hasOfficeMenuItems:!1,officeTakeover:new a,postRender:function(e,t,n){var r=this,i;this.postRenderedOnce&&(this.officeTakeover&&this.officeTakeover.fetch({success:function(e){e.takeoverStatus?r.officeTakeover=undefined:r.onOfficeTakeoverResponse()}}),this.Office=new u,this.listenTo(this.Office,u.Events.READY,this.onOfficeReady,this),this.widgetState.get("stateName")!=="small-state"&&(this.listenTo(this.Office,u.Events.MESSAGE,this.onOfficeMessage,this),this.listenTo(this.Office,u.Events.DISCONNECTED,this.onOfficeDisconnected,this)),this.postRenderedOnce=undefined);var s=[n];this.postRenderedOnce||this.delegateToWidgetStateView("postRender",!1,s),this.postRenderedOnce=!0},onOfficeReady:function(e){this.hasOfficeMenuItems||(e.get("connected")?this.addConnectedOfficeMenuItems():this.addDisconnectedOfficeMenuItem()),this.hasOfficeMenuItems=!0},addConnectedOfficeMenuItems:function(){this.addCustomMenuItem("office365Menu",{key:"office_disconnect",handlerName:"onDisconnectOfficeClicked",index:1}),this.addCustomMenuItem("office365Menu",{key:"office_sharing_options",handlerName:"onOfficeSharingSettingsClicked",index:2})},addDisconnectedOfficeMenuItem:function(){this.addCustomMenuItem("office365Menu",{key:"office_connect",handlerName:"onConnectOfficeClicked",index:1})},onConnectOfficeClicked:function(){this.Office.connect()},onDisconnectOfficeClicked:function(){this.Office.disconnect()},onOfficeSharingSettingsClicked:function(){this.Office.manage()},onOfficeMessage:function(e){var t=new l({messageObj:e});this.displaySheet(t,null,"widget-sheet widget-sheet-bottom")},onOfficeTakeoverResponse:function(){this.office365TakeoverView=new f,this.listenTo(this.office365TakeoverView,f.Events.DISMISS_TAKEOVER,this.onDismissTakeover,this),this.listenTo(this.office365TakeoverView,f.Events.CONNECT,this.onTakeoverConnectClicked,this),this.displayTakeover(this.office365TakeoverView)},onDismissTakeover:function(){this.saveTakeoverStatusAsViewed(),this.currentTakeoverView.$(".widget-takeover-close").click()},onWidgetTakeoverClosed:function(){this.officeTakeover=undefined},onTakeoverConnectClicked:function(){this.saveTakeoverStatusAsViewed(this.onConnectOfficeClicked.bind(this))},saveTakeoverStatusAsViewed:function(e){var t=e?{success:e}:{};this.officeTakeover.save([],t)},onOfficeDisconnected:function(){this.removeMenuItem("office365Menu","office_disconnect"),this.removeMenuItem("office365Menu","office_sharing_options"),this.addDisconnectedOfficeMenuItem()}});return c});