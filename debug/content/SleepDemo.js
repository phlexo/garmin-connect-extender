define("models/sleep/DailySleep",["require","backbone","utils/date/DateParser"],function(e){var t=e("backbone"),n=e("utils/date/DateParser"),r=t.Model.extend({urlRoot:"/proxy/wellness-service/wellness/dailySleep",initialize:function(e){this.date=e.calendarDate},setDisplayName:function(e){this.displayName=e},setBuffer:function(e){this.buffer=e},url:function(){var e=this.urlRoot,t="?";return this.id?(e+="/"+this.id,e):(this.displayName&&(e+="/user/"+this.displayName),this.date&&(e+=t+"date="+this.date,t="&"),this.buffer&&(e+=t+"nonSleepBufferMinutes="+this.buffer),e)},getBaseURL:function(){return this.urlRoot},save:function(e,n){n=n||{};var r=this.get("id")||e.id;return r?n.url=this.urlRoot+"/"+r:n.url=this.urlRoot,t.Model.prototype.save.call(this,e,n)},setToModel:function(e,t){this.set(e,t)},getBedTime:function(e){if(!e)return null;var t=this.getSleepStartTimestampGMT(),r=n.parseISOUTC(e.get("wellnessStartTimeGmt")).getTime(),i=(t-r)/1e3;return i<0&&(i=86400+i),i},getWakeTime:function(e){if(!e)return null;var t=this.getSleepEndTimestampGMT(),r=n.parseISOUTC(e.get("wellnessStartTimeGmt")).getTime(),i=(t-r)/1e3;return i<0&&(i=86400+i),i},getID:function(){return this.get("id")},getCalendarDate:function(){return this.get("calendarDate")},getSleepTimeSeconds:function(){return this.get("sleepTimeSeconds")},getSleepStartTimestampGMT:function(){return this.get("sleepStartTimestampGMT")},getSleepEndTimestampGMT:function(){return this.get("sleepEndTimestampGMT")},getAutoSleepStartTimestampGMT:function(){return this.get("autoSleepStartTimestampGMT")},getAutoSleepEndTimestampGMT:function(){return this.get("autoSleepEndTimestampGMT")},getSleepWindowConfirmed:function(){return this.get("sleepWindowConfirmed")},getNapTimeSeconds:function(){return this.get("napTimeSeconds")},getIsManuallyEnteredSleep:function(){return this.get("sleepWindowConfirmationType")==="off_wrist"&&this.get("sleepWindowConfirmed")},getIsUnmeasurableSleep:function(){return(this.get("sleepWindowConfirmationType")==="off_wrist"||this.get("sleepWindowConfirmationType")==="unconfirmed")&&!this.get("sleepWindowConfirmed")}});return r}),define("models/sleep/DailySleepData",["require","backbone","models/sleep/DailySleep"],function(e){var t=e("backbone"),n=e("models/sleep/DailySleep"),r=t.Model.extend({urlRoot:"/proxy/wellness-service/wellness/dailySleepData",initialize:function(e){this.date=e.calendarDate},setDisplayName:function(e){this.displayName=e},setBuffer:function(e){this.buffer=e},url:function(){var e=this.urlRoot,t="?";return this.id&&(e+="/"+this.id),this.displayName&&(e+="/"+this.displayName),this.date&&(e+=t+"date="+this.date,t="&"),this.buffer&&(e+=t+"nonSleepBufferMinutes="+this.buffer),e},getBaseURL:function(){return this.urlRoot},getSleepLevels:function(){return this.get("sleepLevels")||null},getSleepMovement:function(){return this.get("sleepMovement")||null},getRemSleepData:function(){return this.get("remSleepData")}});return r}),define("collections/sleep/Sleeps",["require","underscore","models/sleep/DailySleep","collections/utils/PagedCollection"],function(e){var t=e("underscore"),n=e("models/sleep/DailySleep"),r=e("collections/utils/PagedCollection");return r.extend({model:n,url:function(){var e="/proxy/wellness-service/wellness/dailySleeps";return this.limit&&(e+="?limit="+this.limit+"&start="+this.startIndex),e},initialize:function(e,t){t.verb="GET",this.initializePagedCollection(t)},findSleepByDate:function(e){return t.find(this.models,function(t){return t.get("calendarDate")===e})}})}),define("models/wellness/MergedSummary",["require","backbone","moment","utils/date/DateUtil"],function(e){var t=e("backbone"),n=e("moment"),r=e("utils/date/DateUtil"),i=t.Model.extend({idAttribute:"uuid",initialize:function(e){this.displayName=e.displayName,this.calendarDate=e.calendarDate},url:function(){return"/modern/proxy/usersummary-service/usersummary/daily/"},sync:function(e,n,r){if(e==="read")r.url=this.url()+this.displayName+"?calendarDate="+this.calendarDate;else if(e==="create"||e==="update")r.url=this.url();t.sync.apply(this,arguments)},setDate:function(e){this.calendarDate=e},isTimeZoneChange:function(){var e=this.get("wellnessStartTimeGmt"),t=this.get("wellnessEndTimeGmt");if(!e||!t)return!1;var n=r.getDateFromISOTimestampString(e).getTime(),i=r.getDateFromISOTimestampString(t).getTime(),s=Math.floor((i-n)/1e3);if(s>86400)return!0;var o=n+864e5,u=(new Date).getTime();return u<o?!1:s<86400?!0:!1},isToday:function(){var e=n(this.get("calendarDate"));return e?e.isSame(n(),"day"):!1}});return i}),define("collections/wellness/MergedSummaries",["require","backbone","models/wellness/MergedSummary","utils/date/DateUtil","collections/utils/PagedCollection"],function(e){var t=e("backbone"),n=e("models/wellness/MergedSummary"),r=e("utils/date/DateUtil"),i=e("collections/utils/PagedCollection"),s=i.extend({model:n,initialize:function(e,t){t.verb="GET",this.displayName=t.displayName,this.startIndex=t.startIndex,this.limit=t.limit,this.maxDate=t.maxDate;if(!this.displayName)throw"displayName required by Merged Summary model";if(!this.startIndex)throw"start is required";if(!this.limit)throw"limit is required";this.maxDate||(this.maxDate=new Date),this.initializePagedCollection(t)},url:function(){var e=r.toISODateString(this.maxDate),t="/modern/proxy/usersummary-service/usersummary/list/";return t+=this.displayName+"?start="+this.startIndex+"&limit="+this.limit+"&maxDate="+e,t}});return s}),define("text!templates/sleep/SleepTimeEditorView.html",[],function(){return'<% if(size === \'LARGE\') { %>\n\n    <div class="data-block small">\n        <div class="static-time">\n            <div class="data-bit">\n                <%= time %>\n\n                <% if(editable) { %>\n                <button class="inline-edit-trigger"><i class="icon-pencil"></i></button>\n                <% } %>\n            </div>\n        </div>\n\n        <% if(editable) { %>\n        <div class="editable-time">\n            <div class="time-picker-placeholder" style="display: inline-block;">\n                <!-- TimePickerView goes here -->\n            </div>\n            <span class="inline-edit-actions">\n                <button class="inline-edit-save icon-checkmark"></button>\n                <button class="inline-edit-cancel icon-close"></button>\n            </span>\n        </div>\n        <% } %>\n\n        <div class="data-block">\n        <% if(mode === \'SLEEP\') { %>\n            <span class="data-label show"><%= Localizer.localize(\'wellness_sleep_start_time\') %></span>\n            <i class="icon-sleep"></i>\n        <% } else { %>\n            <span class="data-label show"><%= Localizer.localize(\'wellness_sleep_wake_time\') %></span>\n            <i class="icon-alarm-clock"></i>\n        <% } %>\n        </div>\n    </div>\n\n<% } else { %>\n\n    <div class="sleep-times">\n        <div class="data-bit">\n            <%= time %>\n        </div>\n\n        <% if(mode === \'SLEEP\') { %>\n            <i class="icon-sleep"></i>\n        <% } else { %>\n            <i class="icon-alarm-clock"></i>\n        <% } %>\n    </div>\n\n<% } %>'}),define("views/sleep/SleepTimeEditorView",["require","underscore","backbone","localizer","models/user/UserPreference","views/utils/TimePickerView","utils/date/DateParser","utils/date/TimeUtil","text!templates/sleep/SleepTimeEditorView.html"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("models/user/UserPreference"),s=e("views/utils/TimePickerView"),o=e("utils/date/DateParser"),u=e("utils/date/TimeUtil"),a=e("text!templates/sleep/SleepTimeEditorView.html"),f={CHANGE:"CHANGE"},l=n.View.extend({events:{"click .inline-edit-trigger":"onEditSleepTime","click .inline-edit-save":"onEditSave","click .inline-edit-cancel":"onEditCancel"},className:"sleep-time-editor",initialize:function(e){if(typeof e.dailySleep=="undefined")throw"dailySleep is required.";this.template=t.template(a),this.dailySleep=e.dailySleep,this.mergedSummary=e.mergedSummary,this.userPreferences=e.userPreferences,this.timeFormat24Hour=e.timeFormat24Hour,this.mode=e.mode&&e.mode==="SLEEP"?"SLEEP":"AWAKE",this.size=e.size&&e.size==="SMALL"?"SMALL":"LARGE",this.editableText=e.editableText,this.initializeOffset()},render:function(){var e;this.mode==="SLEEP"?(this.$el.addClass("bed-time"),e=this.getBedTime()):(this.$el.addClass("wake-time"),e=this.getWakeTime()),this.formattedTime=e!==null?u.formatTime(e,this.timeFormat24Hour):null,this.$el.html(this.template({Localizer:r,mode:this.mode,size:this.size,editable:this.editableText,time:this.formattedTime}))},toggleEditMode:function(){var e=this.$(".static-time"),t=this.$(".editable-time"),n=this.$(".inline-edit-actions button");e.toggle(),t.toggle(),n.toggle()},renderTimePickers:function(){this.sleepTimePickerView=new s({id:"sleepTimeEdit-"+this.mode,el:this.$(".time-picker-placeholder"),userPreferences:this.userPreferences,time:this.formattedTime,required:!0,displayIcon:!1}),this.sleepTimePickerView.listenTo(s.Events.CHANGE,this.onSleepTimeChanged),this.sleepTimePickerView.render()},initializeOffset:function(){this.sleepStartPreference=new i({key:"Wellness.startSleepTimeSecondsFromMidnight"}),this.sleepWakePreference=new i({key:"Wellness.endSleepTimeSecondsFromMidnight"});var e=o.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),t=null,n=null;this.dailySleep.getSleepStartTimestampGMT()?t=(new Date(this.dailySleep.getSleepStartTimestampGMT())).getTime():(this.sleepStartPreference.fetch({async:!1}),this.sleepOffset=this.sleepStartPreference.get("value")?+this.sleepStartPreference.get("value"):79200),this.sleepOffset==null&&(t<e?this.sleepOffset=86400-(e-t)/1e3:this.sleepOffset=(t-e)/1e3),this.dailySleep.getSleepEndTimestampGMT()?(n=(new Date(this.dailySleep.getSleepEndTimestampGMT())).getTime(),n<e?this.wakeOffset=86400-(e-n)/1e3:this.wakeOffset=(n-e)/1e3):(this.sleepWakePreference.fetch({async:!1}),this.wakeOffset=this.sleepWakePreference.get("value")?+this.sleepWakePreference.get("value"):21600)},onEditSleepTime:function(){this.toggleEditMode(),this.renderTimePickers()},onEditCancel:function(){this.toggleEditMode()},onEditSave:function(){var e=this.sleepTimePickerView.time,t=o.parseTime(e);this.mode==="SLEEP"?this.sleepOffset=t:this.wakeOffset=t,this.saveSleepTime()},saveSleepTime:function(){var e=o.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),t=null,n=e+this.wakeOffset*1e3;this.sleepOffset>this.wakeOffset?t=e-864e5+this.sleepOffset*1e3:t=e+this.sleepOffset*1e3,this.dailySleep.setToModel("sleepStartTimestampGMT",t),this.dailySleep.setToModel("sleepEndTimestampGMT",n),this.dailySleep.setToModel("sleepWindowConfirmed",!0),this.dailySleep.setToModel("sleepTimeSeconds",(n-t)/1e3),this.dailySleep.getID()||(this.dailySleep.setToModel("userProfilePK",this.mergedSummary.get("userProfileId")),this.dailySleep.setToModel("calendarDate",this.mergedSummary.get("calendarDate")),this.dailySleep.setToModel("napTimeSeconds",0)),this.trigger(f.CHANGE)},getBedTime:function(){var e=0,t,n;return this.mergedSummary.get("wellnessStartTimeGmt")&&(t=o.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),n=this.dailySleep.getSleepStartTimestampGMT()?this.dailySleep.getSleepStartTimestampGMT():this.dailySleep.getAutoSleepStartTimestampGMT(),e=(n-t)/1e3,e<0&&(e+=86400)),e},getWakeTime:function(){var e=0,t,n;return this.mergedSummary.get("wellnessStartTimeGmt")&&(t=o.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),n=this.dailySleep.getSleepEndTimestampGMT()?this.dailySleep.getSleepEndTimestampGMT():this.dailySleep.getAutoSleepEndTimestampGMT(),e=(n-t)/1e3,e<0&&(e+=86400)),e}});return l.Events=f,l}),define("views/sleep/SleepLevelsChartView",["require","backbone","localizer","views/sleep/SleepTimeEditorView","utils/date/DateFormatter","utils/date/DateParser","utils/date/TimeUtil","highcharts"],function(e){var t=e("backbone"),n=e("localizer"),r=e("views/sleep/SleepTimeEditorView"),i=e("utils/date/DateFormatter"),s=e("utils/date/DateParser"),o=e("utils/date/TimeUtil"),u=e("highcharts"),a=-0.2,f={CHANGE:"CHANGE"},l={black:"#000000",white:"#ffffff",deep_sleep:"#0C7AAB",light_sleep:"#11A9ED",rem_sleep:"#793EAC",awake:"#DF6ECD",manually_entered:"#64AFCD",unmeasurable:"#7E7E7E",grey_1:"#282828",grey_2:"#C5C5C5",grey_3:"#E6E6E6"},c={SMALL:{marginTop:44,marginLeft:20,marginRight:20,height:310,width:290,yAxis:{height:116},xAxis:{plotLines:{x:-30,y:-26},offset:32,labels:{y:20,fontSize:"11px"},y:15}},LARGE:{marginTop:75,marginLeft:28,marginRight:28,height:421,yAxis:{height:216},xAxis:{plotLines:{x:-82,y:-60},offset:40,labels:{y:25,fontSize:"12px"},y:20}}},h=t.View.extend({initialize:function(e){if(typeof e.dailySleep=="undefined")throw"dailySleep is required.";this.sleepLevels=e.sleepLevels,this.dailySleep=e.dailySleep,this.mergedSummary=e.mergedSummary,this.timeFormat24Hour=e.timeFormat24Hour,this.userPreferences=e.userPreferences,this.size=e.size==="SMALL"?"SMALL":"LARGE",this.buffer=e.buffer,this.isManuallyEnteredSleep=e.isManuallyEnteredSleep,this.isUnmeasurableSleep=e.isUnmeasurableSleep||!e.sleepLevels.length>0,this.isRemCapable=e.isRemCapable,this.setProperties()},setProperties:function(){this.sleepTimeGMT=this.dailySleep.getSleepStartTimestampGMT()?this.dailySleep.getSleepStartTimestampGMT():this.dailySleep.getAutoSleepStartTimestampGMT(),this.wakeTimeGMT=this.dailySleep.getSleepEndTimestampGMT()?this.dailySleep.getSleepEndTimestampGMT():this.dailySleep.getAutoSleepEndTimestampGMT(),this.min=this.sleepTimeGMT-this.buffer*6e4,this.max=this.wakeTimeGMT+this.buffer*6e4,this.appendBuffer(this.buffer),this.timeFormat24Hour&&(c.SMALL.xAxis.plotLines.x=-15)},render:function(){Highcharts.setOptions({global:{useUTC:!1}});var e=this.buildSeries(),t=this.buildChartThemeOptions({size:this.size,sleepTimeGMT:this.sleepTimeGMT,wakeTimeGMT:this.wakeTimeGMT,min:this.min,max:this.max});t.series=e,this.chart=new Highcharts.Chart(t),this.$(".highcharts-container").css("z-index",1),this.renderSleepTimeEditorView(),this.renderAwakeTimeEditorView()},renderSleepTimeEditorView:function(){this.sleepTimeEditorView&&this.sleepTimeEditorView.off(),this.sleepTimeEditorView=new r({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,mode:"SLEEP",size:this.size,editableText:!0}),this.listenTo(this.sleepTimeEditorView,r.Events.CHANGE,this.onSleepTimeChange),this.sleepTimeEditorView.render(),this.$el.append(this.sleepTimeEditorView.$el),this.positionSleepTimeEditor()},positionSleepTimeEditor:function(){if(this.sleepTimeEditorView){var e=this.$(".sleep-time-placeholder.bed-time").parent();this.sleepTimeEditorView.$el.css("top",e[0].offsetTop-8),this.sleepTimeEditorView.$el.css("left",e.css("left"))}},positionWakeTimeEditor:function(){if(this.awakeTimeEditorView){var e=this.$(".awake-time-placeholder.wake-time").parent();this.awakeTimeEditorView.$el.css("top",e[0].offsetTop-8),this.awakeTimeEditorView.$el.css("left",e.css("left"))}},renderAwakeTimeEditorView:function(){this.awakeTimeEditorView&&this.awakeTimeEditorView.off(),this.awakeTimeEditorView=new r({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,mode:"AWAKE",size:this.size,editableText:!0}),this.listenTo(this.awakeTimeEditorView,r.Events.CHANGE,this.onSleepTimeChange),this.awakeTimeEditorView.render(),this.$el.append(this.awakeTimeEditorView.$el),this.positionWakeTimeEditor()},onSleepTimeChange:function(){this.trigger(f.CHANGE)},buildSeries:function(){var e=[];e.push(this.buildLowerPlotBand());if(this.isManuallyEnteredSleep){var t=this.isRemCapable?2:1,n={type:"area",color:l.manually_entered,showInLegend:!1,data:[[this.sleepTimeGMT,t],[this.wakeTimeGMT,t]]};e.push(n)}else if(this.isUnmeasurableSleep){var r={type:"area",color:l.unmeasurable,showInLegend:!1,data:[[this.sleepTimeGMT,a],[this.wakeTimeGMT,a]]};e.push(r)}else for(var i=0,s=this.sleepLevels.length;i<s;i++){var t=this.sleepLevels[i],o=this.buildSeriesEntry(t);e.push(o)}return e.push({name:"deep",color:l.deep_sleep,events:{legendItemClick:function(){return!1}}}),e.push({name:"light",color:l.light_sleep,events:{legendItemClick:function(){return!1}}}),this.isRemCapable&&e.push({name:"rem",color:l.rem_sleep,events:{legendItemClick:function(){return!1}}}),e.push({name:"awake",color:l.awake,events:{legendItemClick:function(){return!1}}}),e.push({name:"stress_type_unmeasurable",color:l.unmeasurable,events:{legendItemClick:function(){return!1}}}),e},buildLowerPlotBand:function(){var e=[[this.min,a],[this.max,a]],t={type:"area",data:e,color:l.grey_3,showInLegend:!1};return t},buildSeriesEntry:function(e){var t=s.parseISOUTC(e.startGMT),n=s.parseISOUTC(e.endGMT),r=6e4,i=[],o="";for(var u=t.getTime();u<=n.getTime();u+=r)e.activityLevel===-1?(i.push([u,a]),o=this.getColor(-1)):(i.push([u,e.activityLevel+1]),o=this.getColor(e.activityLevel));return{type:"area",data:i,color:o,showInLegend:!1}},appendBuffer:function(e){var t=this.buildStartBuffer(e),n=this.buildEndBuffer(e);this.sleepLevels.unshift(t),this.sleepLevels.push(n)},buildStartBuffer:function(e){var t=(new Date(this.min)).toISOString(),n=(new Date(this.min+e*6e4)).toISOString();return{startGMT:t,endGMT:n,activityLevel:5}},buildEndBuffer:function(e){var t=(new Date(this.max)).toISOString(),n=(new Date(this.max+e*6e4)).toISOString();return{startGMT:t,endGMT:n,activityLevel:5}},getColor:function(e){return e===-1?l.unmeasurable:e===0?l.deep_sleep:e===1?l.light_sleep:this.isRemCapable&&e===2?l.rem_sleep:e===2||e===3?l.awake:"transparent"},getTitle:function(e){if(e===a)return n.localize("stress_type_unmeasurable");if(e===1)return n.localize("deep_sleep");if(e===2)return n.localize("light_sleep");if(this.isRemCapable){if(e===3)return n.localize("rem_sleep");if(e===4)return n.localize("awake")}else if(e===3)return n.localize("awake")},getSecondsOffset:function(e){var t=s.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),n=(e-t)/1e3;return n<0&&(n=86400+n),n},onChartLoaded:function(e){this.checkTickMarkPositions(e),this.alignFirstAndLastLabels(e),this.alignLabelsInCenter(e)},checkTickMarkPositions:function(e){var t=e.xAxis[0].max,n=e.xAxis[0].min,r=t-n,i=324e5;if(this.size==="SMALL"&&r>i){var s=this.$(e.container),o=s.find(".highcharts-axis-labels span a"),u=o.length-1;$(o[0]).css({display:"none"}),$(o[u]).css({display:"none"})}},alignLabelsInCenter:function(e){var t=this.$(e.container),n=t.find(".highcharts-axis-labels .timeline_label"),r=this;n.each(function(t,n){var i=r.$(n).parent("span"),s=parseInt(i.css("left")),o=i.next(),u=o.length?parseInt(o.css("left")):e.axes[0].left+e.axes[0].width,a=(u+s)/2,f=a-i.width()/2;i.css("left",f+"px")}),this.positionSleepTimeEditor(),this.positionWakeTimeEditor()},alignFirstAndLastLabels:function(e){var t=this.$(e.container),n=t.find(".highcharts-axis-labels .first-time-label"),r=n.parent("span");r.css("left",0);var i=t.find(".highcharts-axis-labels .last-time-label"),s=i.parent("span");s.css("left",e.chartWidth-50)},buildChartThemeOptions:function(e){var t=this,r=e.min,u=e.max,a=s.parseEpoch(e.sleepTimeGMT),f=s.parseEpoch(e.wakeTimeGMT),h=new Date(u);return h.setHours(0,0,0,0),{chart:{renderTo:this.el,className:"allow-overflow",backgroundColor:"transparent",type:"area",marginTop:c[e.size].marginTop,marginLeft:c[e.size].marginLeft,marginRight:c[e.size].marginRight,height:c[e.size].height,width:c[e.size].width,reflow:!0,events:{load:function(){t.onChartLoaded(this)},redraw:function(){t.onChartLoaded(this)}}},credits:{enabled:!1},exporting:{enabled:!1},plotOptions:{area:{marker:{enabled:!1,states:{hover:{enabled:!1}},symbol:"circle"},lineWidth:0},series:{fillOpacity:1}},title:t.getChartTitle(),subtitle:t.getChartSubtitle(),tooltip:{enabled:this.isManuallyEnteredSleep||this.isUnmeasurableSleep?!1:!0,formatter:function(){return this.x>=t.sleepTimeGMT&&this.x<=t.wakeTimeGMT?t.getTitle(this.y)+"<br/>"+o.formatTime(t.getSecondsOffset(this.x),t.timeFormat24Hour):!1},positioner:function(e,n,r){var i={x:r.plotX,y:25};return r.plotX+e>t.chart.plotWidth?i.x=r.plotX+t.chart.plotLeft-e:i.x=r.plotX+t.chart.plotLeft,i},shared:!0,useHTML:!0},xAxis:[{type:"datetime",tickInterval:36e5,title:{text:null},startOnTick:!1,maxPadding:0,min:r,max:u,labels:{y:c[e.size].xAxis.labels.y,autoRotation:!1,staggerLines:1,style:{color:l.black,fontSize:c[e.size].xAxis.labels.fontSize},formatter:function(){var e=!1,n=!0;if(this.isFirst){var i='style="margin-left: 3px"';return'<span class="first-time-label"'+i+">"+o.formatTime(t.getSecondsOffset(r+6e4),t.timeFormat24Hour,e,n)+"</span>"}if(this.isLast){var s='style="margin-left: 16px"';return'<span class="last-time-label"'+s+">"+o.formatTime(t.getSecondsOffset(u),t.timeFormat24Hour,e,n)+"</span>"}return'<a href="javascript:void(0)" style="color:#898989; font-size: 12px" title="'+o.formatTime(t.getSecondsOffset(this.value),t.timeFormat24Hour)+'">&#9679;</a>'},useHTML:!0},tickWidth:0,plotLines:[{color:l.grey_1,dashStyle:"ShortDash",value:a.getTime(),width:2,label:{text:'<div class="sleep-time-placeholder bed-time">&nbsp;</div>',useHTML:!0,rotation:0,textAlign:"left",x:c[e.size].xAxis.plotLines.x,y:c[e.size].xAxis.plotLines.y,style:{fontFamily:"'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif"}},zIndex:5,padding:.5},{color:l.grey_1,dashStyle:"ShortDash",value:f.getTime(),width:2,label:{text:'<div class="awake-time-placeholder wake-time">&nbsp;</div>',useHTML:!0,rotation:0,textAlign:"left",x:c[e.size].xAxis.plotLines.x,y:c[e.size].xAxis.plotLines.y,style:{fontFamily:"'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif"}},zIndex:5}]},{type:"datetime",title:{text:null},lineColor:l.grey_2,linkedTo:0,offset:c[e.size].xAxis.offset,startOnTick:!0,min:r,labels:{autoRotation:!1,align:"left",staggerLines:1,useHTML:!0,style:{color:l.black,fontSize:c[e.size].xAxis.labels.fontSize},formatter:function(){if(this.isLast)return"";var e=s.parseEpoch(this.value),t=i.formatMonthDay(e);return'<span class="timeline_label">'+t.toUpperCase()+"</span>"},y:c[e.size].xAxis.y},tickWidth:1,tickPosition:"inside",tickPositions:[r,h.getTime(),u]}],yAxis:t.getYAxesConfig(),legend:{borderColor:"transparent",useHTML:!0,y:20,itemDistance:t.size==="LARGE"?45:40,itemMarginBottom:t.size==="LARGE"?10:10,itemWidth:t.size==="LARGE"?null:130,itemMarginTop:t.size==="LARGE"?15:0,symbolHeight:t.size==="LARGE"?18:14,itemStyle:{cursor:"default",fontWeight:"bold",fontSize:t.size==="LARGE"?"14px":"12px",lineHeight:t.size==="LARGE"?"18px":"16px"},labelFormatter:function(){return n.localize(this.name)}}}},getYAxesConfig:function(){var e=[],t=3,n=[a,0,1,2,3];return this.isRemCapable&&(t=4,n=[a,0,1,2,3,4]),e.push({gridLineColor:l.grey_3,labels:{enabled:!1},title:{text:""},lineWidth:0,max:t,min:a,tickPositions:n}),e},getChartTitle:function(){var e=null,t,r,i;return this.isRemCapable?this.isManuallyEnteredSleep?(e=n.localize("sleep_time_entered_manually"),t=this.size==="LARGE"?232:125,r=this.size==="LARGE"?18:13,i=l.white):this.isUnmeasurableSleep&&(e=n.localize("no_sleep_level_data"),t=this.size==="LARGE"?154:84,r=this.size==="LARGE"?22:14,i=l.unmeasurable):this.isManuallyEnteredSleep?(e=n.localize("sleep_time_entered_manually"),t=this.size==="LARGE"?245:154,r=this.size==="LARGE"?18:13,i=l.white):this.isUnmeasurableSleep&&(e=n.localize("no_sleep_level_data"),t=this.size==="LARGE"?178:64,r=this.size==="LARGE"?22:14,i=l.unmeasurable),{text:e,y:t,style:{fontFamily:"'Open Sans', sans-serif",color:i,fontSize:r}}},getChartSubtitle:function(){var e=null,t,r,i;return this.isRemCapable?this.isUnmeasurableSleep&&(e=n.localize("to_receive_sleep_level_data"),t=this.size==="LARGE"?204:103,r=this.size==="LARGE"?13:10,i=l.unmeasurable):this.isUnmeasurableSleep&&(e=n.localize("to_receive_sleep_level_data"),t=this.size==="LARGE"?243:101,r=this.size==="LARGE"?13:10,i=l.unmeasurable),{text:e,y:t,widthAdjust:-60,style:{fontFamily:"'Open Sans', sans-serif",color:i,fontSize:r}}},reflow:function(){this.chart&&this.chart.reflow()}});return h.Events=f,h}),define("text!widgets/sleep/templates/SleepTimeDemoView.html",[],function(){return'<div class="sleep-total-value data-bit">\n	<span class="has-tooltip" data-html="true" title="<%= Localizer.localize(\'sleep_widget_total_tip\') %>">\n		<abbr class="sleep-total-label"><%= Localizer.localize(\'wellness_sleep_total_sleep\') %></abbr>\n\n		<span class="sleep-total-time">: <%= Localizer.localize(\'wellness_sleep_total_hours\', TimeUtil.formatTime24Hour(sleepTimeSeconds)) %></span>\n	</span>\n	<button class="icon-pencil sleep-times-trigger"></button>\n</div>'}),define("widgets/sleep/views/SleepTimeDemoView",["require","underscore","backbone","localizer","personalizer","models/user/ViewerSocialProfile","views/utils/ToolTipView","utils/date/TimeUtil","text!widgets/sleep/templates/SleepTimeDemoView.html","jquerymenus"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("personalizer"),s=e("models/user/ViewerSocialProfile"),o=e("views/utils/ToolTipView"),u=e("utils/date/TimeUtil"),a=e("text!widgets/sleep/templates/SleepTimeDemoView.html"),f=e("jquerymenus"),l={CHANGE:"CHANGE",EDIT:"EDIT"},c=n.View.extend({events:{"click .sleep-times-trigger":"onEditSleepTimeClicked"},initialize:function(e){if(typeof e.dailySleep=="undefined")throw"Daily Sleep is required.";if(typeof e.userPreferences=="undefined")throw"User Preferences object is required.";this.dailySleep=e.dailySleep,this.userPreferences=e.userPreferences,this.template=t.template(a)},render:function(){var e=s.get("profileId");this.html=this.template({Localizer:r,Personalizer:i,TimeUtil:u,sleepTimeSeconds:(this.dailySleep.getSleepTimeSeconds()||0)+(this.dailySleep.getNapTimeSeconds()||0),viewerUserProfilePK:e,ownerUserProfilePK:e}),this.$el.html(this.html),this.initToolTip()},initToolTip:function(){var e=this.$(".has-tooltip");this.toolTip=new o({el:e,content:e.data("original-title")})},onSleepTimeChanged:function(){this.trigger(l.CHANGE),this.render()},onEditSleepTimeClicked:function(){this.trigger(l.EDIT)}});return c.Events=l,c}),define("text!widgets/sleep/templates/SleepTimeEditView.html",[],function(){return'<!-- Widget view -->\n<h5 class="sleep-time-header time-confirm"><%= Localizer.localize(\'sleep_widget_confirm_sleep_time\') %></h5>\n\n<div class="sleep-time-entry-container clearfix">\n    <div class="span4 data-1">\n        <label class="data-label" for="sleepStartTime_1"><%= Localizer.localize(\'wellness_sleep_start_time\') %></label>\n        <div class="data-bit sleep-start-container"></div>\n    </div>\n    <div class="span4 data-1">\n        <label class="data-label" for="sleepWakeTime1"><%= Localizer.localize(\'wellness_sleep_wake_time\') %></label>\n        <div class="data-bit sleep-wake-container"></div>\n    </div>\n    <button class="btn left-xs pull-right sleep-time-save"><%= Localizer.localize(\'save\') %></button>\n</div>    \n'}),define("widgets/sleep/views/SleepTimeEditView",["require","underscore","backbone","localizer","personalizer","models/user/ViewerSocialProfile","models/user/UserPreference","views/utils/TimePickerView","utils/date/TimeUtil","utils/date/DateUtil","utils/date/DateParser","text!widgets/sleep/templates/SleepTimeEditView.html"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("personalizer"),s=e("models/user/ViewerSocialProfile"),o=e("models/user/UserPreference"),u=e("views/utils/TimePickerView"),a=e("utils/date/TimeUtil"),f=e("utils/date/DateUtil"),l=e("utils/date/DateParser"),c=e("text!widgets/sleep/templates/SleepTimeEditView.html"),h={CHANGE:"CHANGE"},p=n.View.extend({events:{"click .sleep-time-save":"onSleepSaveClicked"},initialize:function(e){if(typeof e.dailySleep=="undefined")throw"Daily Sleep is required.";if(typeof e.userPreferences=="undefined")throw"User Preferences object is required.";this.mergedSummary=e.mergedSummary,this.dailySleep=e.dailySleep,this.userPreferences=e.userPreferences,this.viewTemplate=e.viewTemplate,this.timeFormat24Hour=this.userPreferences.is24HourFormat(),this.sleepStartPreference=new o({key:"Wellness.startSleepTimeSecondsFromMidnight"}),this.sleepWakePreference=new o({key:"Wellness.endSleepTimeSecondsFromMidnight"}),this.template=t.template(c)},render:function(){this.sleepTimePickerView&&this.sleepTimePickerView.remove(),this.wakeTimePickerView&&this.wakeTimePickerView.remove(),this.html=this.template({Localizer:r,Personalizer:i,sleepTotalHours:this.dailySleep.getSleepTimeSeconds()/3600,viewerUserProfilePK:s.get("profileId"),viewTemplate:this.viewTemplate}),this.$el.html(this.html);var e=this.mergedSummary?f.getDateFromISOTimestampString(this.mergedSummary.get("wellnessStartTimeGmt")).getTime():l.parseISO(this.dailySleep.getCalendarDate()).getTime(),t=null,n=null;this.dailySleep.getSleepStartTimestampGMT()?t=(new Date(this.dailySleep.getSleepStartTimestampGMT())).getTime():(this.sleepStartPreference.fetch({async:!1}),this.sleepOffset=this.sleepStartPreference.get("value")?+this.sleepStartPreference.get("value"):79200),this.sleepOffset==null&&(t<e?this.sleepOffset=86400-(e-t)/1e3:this.sleepOffset=(t-e)/1e3),this.dailySleep.getSleepEndTimestampGMT()?(n=(new Date(this.dailySleep.getSleepEndTimestampGMT())).getTime(),n<e?this.wakeOffset=86400-(e-n)/1e3:this.wakeOffset=(n-e)/1e3):(this.sleepWakePreference.fetch({async:!1}),this.wakeOffset=this.sleepWakePreference.get("value")?+this.sleepWakePreference.get("value"):21600),this.sleepTimePickerView=new u({id:"sleepStartTime",time:a.formatTime(this.sleepOffset,this.timeFormat24Hour),userPreferences:this.userPreferences,required:!0,el:jQuery(".sleep-start-container")}),this.sleepTimePickerView.on(u.Events.CHANGE,this.onSleepTimeChanged,this),this.sleepTimePickerView.render(),this.wakeTimePickerView=new u({id:"sleepWakeTime",time:a.formatTime(this.wakeOffset,this.timeFormat24Hour),userPreferences:this.userPreferences,required:!0,el:jQuery(".sleep-wake-container")}),this.wakeTimePickerView.on(u.Events.CHANGE,this.onWakeTimeChanged,this),this.wakeTimePickerView.render()},onSleepTimeChanged:function(e,t){this.sleepOffset=t},onWakeTimeChanged:function(e,t){this.wakeOffset=t},onSleepSaveClicked:function(){if(!this.isValidTime())return;var e=this.mergedSummary?f.getDateFromISOTimestampString(this.mergedSummary.get("wellnessStartTimeGmt")).getTime():l.parseISO(this.dailySleep.getCalendarDate()).getTime(),t=null;this.sleepOffset>this.wakeOffset?t=e-864e5+this.sleepOffset*1e3:t=e+this.sleepOffset*1e3,this.dailySleep.setToModel("sleepStartTimestampGMT",t);var n=e+this.wakeOffset*1e3;this.dailySleep.setToModel("sleepEndTimestampGMT",n),this.dailySleep.setToModel("sleepWindowConfirmed",!0),this.dailySleep.setToModel("sleepTimeSeconds",(n-t)/1e3),this.dailySleep.getID()||(this.dailySleep.setToModel("userProfilePK",this.mergedSummary.get("userProfileId")),this.dailySleep.setToModel("calendarDate",this.mergedSummary.get("calendarDate")),this.dailySleep.setToModel("napTimeSeconds",0));var r=this,i=function(){r.onDailySleepSaved()};this.dailySleep.save(this.dailySleep.attributes,{success:i})},onDailySleepSaved:function(){this.trigger(h.CHANGE)},isValidTime:function(){return this.sleepTimePickerView.validate()!==""?!1:this.wakeTimePickerView.validate()!==""?!1:!0},onViewClosed:function(){this.sleepTimePickerView.timeValidator.reporter.remove(),this.wakeTimePickerView.timeValidator.reporter.remove()}});return p.Events=h,p}),define("text!widgets/sleep/templates/SleepLevels.html",[],function(){return'<% var dailyLink = url(\'/daily-summary/\' + displayName + \'/\' + mergedSummary.calendarDate + \'/sleep\'); %>\n\n<div class="data-1 bottom-xs">\n    <h3 class="data-bit"><a href="<%= dailyLink %>" class="daily-sleep-link"><%= calendarDate %></a></h3>\n    <span class="data-label">\n        <% if (syncDate && isToday) { %>\n            <%= Localizer.localize(\'step_summary_synced\') %> <%= syncDate ? Personalizer.personalizeDateAndTime(syncDate, Localizer) : \'\' %>\n        <% } else if(isToday) { %>\n            <%= Localizer.localize(\'step_summary_not_synced\') %>\n        <% } %>\n    </span>\n	<div class="sleep-time-container"></div>\n</div>\n\n<div class="chart-container top-none">\n    <div class="chart chart-widget sleep-levels-chart-placeholder top-none" ></div>\n</div>\n'}),define("text!widgets/sleep/templates/noData.html",[],function(){return'<div class="genesis-message centered top-xl bottom-m">\n	<i class="icon-sleep"></i>\n	<h5 class="top-s"><%= Localizer.localize(\'daily_summary_no_sleep_message\') %></h5>\n</div>'}),define("widgets/sleep/states/SleepLevelsState",["require","underscore","localizer","constants/main/ApplicationEvents","views/main/WidgetStateView","models/sleep/DailySleep","models/sleep/DailySleepData","models/system/SystemPreference","models/user/ViewerSocialProfile","collections/sleep/Sleeps","collections/wellness/MergedSummaries","utils/ModelSynchronizer","utils/date/DateParser","utils/date/DateFormatter","utils/NavigationUtil","views/sleep/SleepLevelsChartView","widgets/sleep/views/SleepTimeDemoView","widgets/sleep/views/SleepTimeEditView","text!widgets/sleep/templates/SleepLevels.html","text!widgets/sleep/templates/noData.html","jquerymenus"],function(e){var t=e("underscore"),n=e("localizer"),r=e("constants/main/ApplicationEvents"),i=e("views/main/WidgetStateView"),s=e("models/sleep/DailySleep"),o=e("models/sleep/DailySleepData"),u=e("models/system/SystemPreference"),a=e("models/user/ViewerSocialProfile"),f=e("collections/sleep/Sleeps"),l=e("collections/wellness/MergedSummaries"),c=e("utils/ModelSynchronizer"),h=e("utils/date/DateParser"),p=e("utils/date/DateFormatter"),d=e("utils/NavigationUtil"),v=e("views/sleep/SleepLevelsChartView"),m=e("widgets/sleep/views/SleepTimeDemoView"),g=e("widgets/sleep/views/SleepTimeEditView"),y=e("text!widgets/sleep/templates/SleepLevels.html"),b=e("text!widgets/sleep/templates/noData.html"),w=e("jquerymenus");return i.extend({name:"sleepLevels",titleKeyName:"title_sleep_widget",menuKeyName:"sleep_levels",stateClassName:"widget-large sleep",templateHtml:y,noDataTemplateHtml:b,headerUrl:function(){var e=new Date,t=p.formatISODate(e);return"/daily-summary/"+this.getDisplayName()+"/"+t+"/sleep"},applicationEvents:{SLEEP_WINDOW_CHANGED:"onSleepWindowChanged"},initializeWidgetState:function(){this.sleeps=new f([],{startIndex:1,limit:10}),this.mergedSummaries=new l([],{displayName:this.getDisplayName(),startIndex:1,limit:10}),this.remSleepEnabledPreference=new u({preferenceKey:"REMSleep.enabled"})},maxPage:function(){return this.mergedSummaries.hasMoreMembers()?9999:this.mergedSummaries.length-1},numLoadedPages:function(){return this.mergedSummaries.length},provideModels:function(e){if(this.sleeps.length===0)return{classIconName:"icon-sleep"};this.mergedSummary=this.mergedSummaries.at(e),this.isToday=this.mergedSummary.isToday(),this.dailySleep=this.sleeps.findSleepByDate(this.mergedSummary.get("calendarDate")),this.dailySleep||(this.dailySleep=new s({calendarDate:this.mergedSummary.get("calendarDate")}));var t=null;if(this.mergedSummary){var n=this.mergedSummary.get("lastSyncTimestampGMT");t=n!==null?h.parseISOUTC(n).getTime():null}return{displayName:this.getDisplayName(),classIconName:"icon-sleep",calendarDate:p.formatFriendlyDate(h.parseISO(this.mergedSummary.get("calendarDate"))),mergedSummary:this.mergedSummary?this.mergedSummary.toJSON():{},syncDate:t,isToday:this.isToday,url:d.url}},fetchMore:function(){var e=new c;e.addModel({model:this.sleeps,required:!0}),e.addModel({model:this.mergedSummaries,required:!0}),e.addModel({model:this.remSleepEnabledPreference,required:!0});var t=this;e.bind(c.Events.SYNCHRONIZED,function(){t.fetchMoreComplete()},this),e.fetchModels()},provideDependencies:function(e){e.addModel({model:this.mergedSummaries,required:!0}),e.addModel({model:this.sleeps,required:!0}),e.addModel({model:this.remSleepEnabledPreference,required:!0})},formatFooter:function(){return p.formatFriendlyDate(h.parseISO(this.mergedSummary.get("calendarDate")),"short")},postRender:function(){if(this.sleeps.length===0)return;(!this.dailySleep||!this.dailySleep.getSleepWindowConfirmed())&&this.onEditSleepTimeClicked(),this.fetchDailySleepData()},fetchDailySleepData:function(){var e=new c;this.dailySleep.getSleepTimeSeconds()<3600?this.buffer=this.dailySleep.getSleepTimeSeconds()/60:this.buffer=60,this.dailySleepData=new o({calendarDate:this.dailySleep.getCalendarDate()}),this.dailySleepData.setDisplayName(this.getDisplayName()),this.dailySleepData.setBuffer(this.buffer),e.addModel({model:this.dailySleepData,required:!0}),this.listenTo(e,c.Events.SYNCHRONIZED,function(){this.renderWidget()}),this.listenTo(e,c.Events.SYNCHRONIZE_FAILED,function(){this.widgetView.onDependenciesLoadFailed()}),e.fetchModels()},renderWidget:function(){this.isRemCapable=this.dailySleepData.getRemSleepData()&&this.getIsRemEnabled(),this.renderSleepTimeDemoView(),this.displaySleepChart()},getIsRemEnabled:function(){var e=a.hasMBTesterRole(),t=this.remSleepEnabledPreference.get("value")==="true";return e||t},renderSleepTimeDemoView:function(){this.sleepTimeDemoView&&this.sleepTimeDemoView.off(),this.sleepTimeDemoView=new m({el:this.$(".sleep-time-container"),dailySleep:this.dailySleep,userPreferences:this.userPreferences}),this.sleepTimeDemoView.on(m.Events.EDIT,this.onEditSleepTimeClicked,this),this.sleepTimeDemoView.render()},onSleepTimeChanged:function(){this.raiseApplicationEvent(r.SLEEP_WINDOW_CHANGED,this.dailySleep)},onSleepWindowChanged:function(e,t){t&&(t.getCalendarDate()===this.dailySleep.getCalendarDate()?(this.dailySleep=t,this.fetchDailySleepData(),this.closeWidgetSheet()):this.replaceSleepModel(t))},onEditSleepTimeClicked:function(){var e=new g({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,userPreferences:this.userPreferences,viewTemplate:"widget"});e.on(g.Events.CHANGE,this.onSleepTimeChanged,this),this.displaySheet(e,null,"widget-sheet widget-sheet-bottom widget-sheet-prev-results allow-overflow")},displaySleepChart:function(){if(!this.dailySleepData)throw"Daily Sleep Data is required";this.timeFormat24Hour=this.userPreferences.is24HourFormat();if(!this.getHasSleepData()){this.renderNoSleepData();return}this.renderSleepLevelsChartsView()},getHasSleepData:function(){return this.dailySleep&&this.dailySleep.getSleepTimeSeconds()},renderNoSleepData:function(){var e=t.template(b);this.$(".sleep-levels-chart-placeholder").html(e({Localizer:n}))},renderSleepLevelsChartsView:function(){this.sleepLevelsChartView=new v({el:this.$(".sleep-levels-chart-placeholder"),size:"SMALL",sleepLevels:this.dailySleepData.getSleepLevels(),dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,buffer:this.buffer,isManuallyEnteredSleep:this.dailySleep.getIsManuallyEnteredSleep(),isUnmeasurableSleep:this.dailySleep.getIsUnmeasurableSleep(),isRemCapable:this.isRemCapable}),this.sleepLevelsChartView.render()},replaceSleepModel:function(e){for(var t=0;t<this.sleeps.length;t++)if(this.sleeps.at(t).getCalendarDate()===e.getCalendarDate()){this.sleeps.remove(this.sleeps.at(t)),this.sleeps.add(e,{at:t});break}}})}),define("views/sleep/SleepMovementChartView",["require","underscore","backbone","localizer","views/sleep/SleepTimeEditorView","utils/date/DateFormatter","utils/date/DateParser","utils/date/TimeUtil","highcharts"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("views/sleep/SleepTimeEditorView"),s=e("utils/date/DateFormatter"),o=e("utils/date/DateParser"),u=e("utils/date/TimeUtil"),a=e("highcharts"),f={CHANGE:"CHANGE"},l={black:"#000000",white:"#ffffff",unmeasurable:"#7E7E7E",grey_1:"#282828",grey_2:"#C5C5C5",grey_3:"#E6E6E6",blue_1:"#11a9ed",blue_2:"#67C7F2",blue_3:"#BFE7F8",blue_4:"#76ccf3"},c={SMALL:{marginTop:44,marginLeft:20,marginRight:20,height:256,width:290,yAxis:{height:116},xAxis:{plotLines:{x:-30,y:-26},offset:32,labels:{y:20,fontSize:"11px"},y:15}},LARGE:{marginTop:75,marginLeft:28,marginRight:28,height:375,yAxis:{height:216},xAxis:{plotLines:{x:-83,y:-60},offset:40,labels:{y:25,fontSize:"12px"},y:20}}},h=n.View.extend({initialize:function(e){if(typeof e.dailySleep=="undefined")throw"dailySleep is required.";this.size=e.size&&e.size==="SMALL"?"SMALL":"LARGE",this.sleepMovement=e.sleepMovement,this.dailySleep=e.dailySleep,this.mergedSummary=e.mergedSummary,this.timeFormat24Hour=e.timeFormat24Hour,this.userPreferences=e.userPreferences,this.yMax=e.yMax?e.yMax:3,this.buffer=e.buffer,this.isManuallyEnteredSleep=e.isManuallyEnteredSleep,this.isUnmeasurableSleep=e.isUnmeasurableSleep||!e.sleepMovement.length>0,this.setProperties()},setProperties:function(){this.sleepTimeGMT=this.dailySleep.getSleepStartTimestampGMT()?this.dailySleep.getSleepStartTimestampGMT():this.dailySleep.getAutoSleepStartTimestampGMT(),this.wakeTimeGMT=this.dailySleep.getSleepEndTimestampGMT()?this.dailySleep.getSleepEndTimestampGMT():this.dailySleep.getAutoSleepEndTimestampGMT(),this.min=this.sleepTimeGMT-this.buffer*6e4,this.max=this.wakeTimeGMT+this.buffer*6e4,this.timeFormat24Hour&&(c.SMALL.xAxis.plotLines.x=-15)},render:function(){Highcharts.setOptions({global:{useUTC:!1}});var e=this.buildSeries(),t=this.buildChartThemeOptions({size:this.size,sleepTimeGMT:this.sleepTimeGMT,wakeTimeGMT:this.wakeTimeGMT,min:this.min,max:this.max});t.series=e,this.chart=new Highcharts.Chart(t),this.$(".highcharts-container").css("z-index",1),this.renderSleepTimeEditorView(),this.renderAwakeTimeEditorView()},renderSleepTimeEditorView:function(){this.sleepTimeEditorView&&this.sleepTimeEditorView.off(),this.sleepTimeEditorView=new i({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,mode:"SLEEP",size:this.size,editableText:!0}),this.listenTo(this.sleepTimeEditorView,i.Events.CHANGE,this.onSleepTimeChange),this.sleepTimeEditorView.render(),this.$el.append(this.sleepTimeEditorView.$el),this.positionSleepTimeEditor()},renderAwakeTimeEditorView:function(){this.awakeTimeEditorView&&this.awakeTimeEditorView.off(),this.awakeTimeEditorView=new i({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,mode:"AWAKE",size:this.size,editableText:!0}),this.listenTo(this.awakeTimeEditorView,i.Events.CHANGE,this.onSleepTimeChange),this.awakeTimeEditorView.render(),this.$el.append(this.awakeTimeEditorView.$el),this.positionWakeTimeEditor()},positionSleepTimeEditor:function(){if(this.sleepTimeEditorView){var e=this.$(".sleep-time-placeholder.bed-time").parent();this.sleepTimeEditorView.$el.css("top",e[0].offsetTop-8),this.sleepTimeEditorView.$el.css("left",e.css("left"))}},positionWakeTimeEditor:function(){if(this.awakeTimeEditorView){var e=this.$(".awake-time-placeholder.wake-time").parent();this.awakeTimeEditorView.$el.css("top",e[0].offsetTop-8),this.awakeTimeEditorView.$el.css("left",e.css("left"))}},onSleepTimeChange:function(){this.trigger(f.CHANGE)},getSecondsOffset:function(e){var t=o.parseISOUTC(this.mergedSummary.get("wellnessStartTimeGmt")).getTime(),n=(e-t)/1e3;return n<0&&(n=86400+n),n},onChartLoaded:function(e){this.checkTickMarkPositions(e),this.alignFirstAndLastLabels(e),this.alignLabelsInCenter(e),setTimeout(function(){e.reflow()},50)},checkTickMarkPositions:function(e){var t=e.xAxis[0].max,n=e.xAxis[0].min,r=t-n,i=324e5;if(this.size==="SMALL"&&r>i){var s=this.$(e.container),o=s.find(".highcharts-axis-labels span a"),u=o.length-1;$(o[0]).css({display:"none"}),$(o[u]).css({display:"none"})}},alignLabelsInCenter:function(e){var t=this.$(e.container),n=t.find(".highcharts-axis-labels .timeline_label"),r=this;n.each(function(t,n){var i=r.$(n).parent("span"),s=parseInt(i.css("left")),o=i.next(),u=o.length?parseInt(o.css("left")):e.axes[0].left+e.axes[0].width,a=(u+s)/2,f=a-i.width()/2;i.css("left",f+"px")}),this.positionSleepTimeEditor(),this.positionWakeTimeEditor()},alignFirstAndLastLabels:function(e){var t=this.$(e.container),n=t.find(".highcharts-axis-labels .first-time-label"),r=n.parent("span");r.css("left",0);var i=t.find(".highcharts-axis-labels .last-time-label"),s=i.parent("span");s.css("left",e.chartWidth-50)},buildSeries:function(){var e=this,t=[],n=this.buildSleepMovementData();return t.push({type:"area",data:n,marker:{enabled:!1,states:{hover:{enabled:!0}},symbol:"circle",fillColor:l.blue_1},color:l.blue_2,lineColor:l.blue_1,fillOpacity:.9,states:{hover:{enabled:!0,halo:null}},zoneAxis:"x",zones:[{fillColor:l.blue_3,color:l.blue_1,value:e.sleepTimeGMT},{fillColor:l.blue_4,fillOpacity:.9,color:l.blue_1,value:e.wakeTimeGMT},{fillColor:l.blue_3,color:l.blue_1}]}),t},buildSleepMovementData:function(){var e=[],n=this.yMax;return this.isManuallyEnteredSleep||this.isUnmeasurableSleep?e.push([0,0]):t.each(this.sleepMovement,function(t){var r=o.parseISOUTC(t.startGMT).getTime(),i=t.activityLevel;i>=n&&(i=n-.01),e.push([r,i])}),e},getYAxisTitle:function(){return this.size==="SMALL"?r.localize("wellness_sleep_movement"):""},buildChartThemeOptions:function(e){var t=this,n=e.min,r=e.max,i=o.parseEpoch(e.sleepTimeGMT),a=o.parseEpoch(e.wakeTimeGMT),f=new Date(r);return f.setHours(0,0,0,0),{chart:{renderTo:this.el,className:"allow-overflow",backgroundColor:"transparent",type:"area",marginTop:c[e.size].marginTop,marginLeft:c[e.size].marginLeft,marginRight:c[e.size].marginRight,height:c[e.size].height,width:c[e.size].width,reflow:!0,events:{load:function(){t.onChartLoaded(this)},redraw:function(){t.onChartLoaded(this)}}},credits:{enabled:!1},exporting:{enabled:!1},title:t.getChartTitle(),subtitle:t.getChartSubtitle(),tooltip:{enabled:this.isManuallyEnteredSleep||this.isUnmeasurableSleep?!1:!0,formatter:function(){return u.formatTime(t.getSecondsOffset(this.x),t.timeFormat24Hour)},positioner:function(e,n,r){var i={x:r.plotX,y:40};return r.plotX+e>t.chart.plotWidth?i.x=r.plotX+t.chart.plotLeft-e:i.x=r.plotX+t.chart.plotLeft,i},shared:!0,useHTML:!0},xAxis:[{type:"datetime",tickInterval:36e5,title:{text:null},startOnTick:!1,maxPadding:0,min:n,max:r,labels:{y:c[e.size].xAxis.labels.y,autoRotation:!1,staggerLines:1,style:{color:l.black,fontSize:c[e.size].xAxis.labels.fontSize},formatter:function(){var e=!1,i=!0;if(this.isFirst){var s='style="margin-left: 3px"';return'<span class="first-time-label"'+s+">"+u.formatTime(t.getSecondsOffset(n+6e4),t.timeFormat24Hour,e,i)+"</span>"}if(this.isLast){var o='style="margin-left: 16px"';return'<span class="last-time-label"'+o+">"+u.formatTime(t.getSecondsOffset(r),t.timeFormat24Hour,e,i)+"</span>"}return'<a href="javascript:void(0)" style="color:#898989; font-size: 12px" title="'+u.formatTime(t.getSecondsOffset(this.value),t.timeFormat24Hour)+'">&#9679;</a>'},useHTML:!0},tickWidth:0,plotLines:[{color:l.grey_1,dashStyle:"ShortDash",value:i.getTime(),width:2,label:{text:'<div class="sleep-time-placeholder bed-time">&nbsp;</div>',useHTML:!0,rotation:0,textAlign:"left",x:c[e.size].xAxis.plotLines.x,y:c[e.size].xAxis.plotLines.y,style:{fontFamily:"'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif"}},zIndex:5,padding:.5},{color:l.grey_1,dashStyle:"ShortDash",value:a.getTime(),width:2,label:{text:'<div class="awake-time-placeholder wake-time">&nbsp;</div>',useHTML:!0,rotation:0,textAlign:"left",x:c[e.size].xAxis.plotLines.x,y:c[e.size].xAxis.plotLines.y,style:{fontFamily:"'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif"}},zIndex:5}]},{type:"datetime",title:{text:null},lineColor:l.grey_2,linkedTo:0,offset:c[e.size].xAxis.offset,startOnTick:!0,min:n,labels:{autoRotation:!1,align:"left",staggerLines:1,useHTML:!0,style:{color:l.black,fontSize:c[e.size].xAxis.labels.fontSize},formatter:function(){if(this.isLast)return"";var e=o.parseEpoch(this.value),t=s.formatMonthDay(e);return'<span class="timeline_label">'+t.toUpperCase()+"</span>"},y:c[e.size].xAxis.y},tickWidth:1,tickPosition:"inside",tickPositions:[n,f.getTime(),r]}],yAxis:[{gridLineColor:l.grey_3,labels:{enabled:!1},title:{text:""},lineWidth:0,max:3,tickInterval:.75}],legend:{enabled:!1}}},getChartTitle:function(){var e=this,t="";if(this.isManuallyEnteredSleep||this.isUnmeasurableSleep)t={text:r.localize("no_sleep_movement_data"),y:e.size==="LARGE"?158:95,style:{fontFamily:"'Open Sans', sans-serif",color:l.unmeasurable,fontSize:e.size==="LARGE"?22:14}};return t},getChartSubtitle:function(){var e=this,t="";if(this.isManuallyEnteredSleep||this.isUnmeasurableSleep)t={text:r.localize("to_receive_sleep_movement_data"),widthAdjust:e.size==="LARGE"?-180:-80,y:e.size==="LARGE"?209:124,style:{fontFamily:"'Open Sans', sans-serif",color:l.unmeasurable,fontSize:e.size==="LARGE"?13:10}};return t},reflow:function(){this.chart&&this.chart.reflow()}});return h.Events=f,h}),define("text!widgets/sleep/templates/SleepMovement.html",[],function(){return'<% var dailyLink = url(\'/daily-summary/\' + displayName + \'/\' + mergedSummary.calendarDate + \'/sleep\'); %>\n\n<div class="data-1 bottom-xs">\n    <h3 class="data-bit"><a href="<%= dailyLink %>" class="daily-sleep-link"><%= calendarDate %></a></h3>\n    <span class="data-label">\n        <% if (syncDate && isToday) { %>\n            <%= Localizer.localize(\'step_summary_synced\') %> <%= syncDate ? Personalizer.personalizeDateAndTime(syncDate, Localizer) : \'\' %>\n        <% } else if(isToday) { %>\n            <%= Localizer.localize(\'step_summary_not_synced\') %>\n        <% } %>\n    </span>\n	<div class="sleep-time-container"></div>\n</div>\n\n<div class="chart-container top-m">\n    <div class="chart chart-widget sleep-movement-chart-placeholder top-s" style="position: relative;"></div>\n</div>'}),define("widgets/sleep/states/SleepMovementState",["require","underscore","localizer","constants/main/ApplicationEvents","views/main/WidgetStateView","models/sleep/DailySleep","models/sleep/DailySleepData","collections/sleep/Sleeps","collections/wellness/MergedSummaries","utils/ModelSynchronizer","utils/date/DateParser","utils/date/DateFormatter","utils/NavigationUtil","views/sleep/SleepMovementChartView","widgets/sleep/views/SleepTimeDemoView","widgets/sleep/views/SleepTimeEditView","text!widgets/sleep/templates/SleepMovement.html","text!widgets/sleep/templates/noData.html","jquerymenus"],function(e){var t=e("underscore"),n=e("localizer"),r=e("constants/main/ApplicationEvents"),i=e("views/main/WidgetStateView"),s=e("models/sleep/DailySleep"),o=e("models/sleep/DailySleepData"),u=e("collections/sleep/Sleeps"),a=e("collections/wellness/MergedSummaries"),f=e("utils/ModelSynchronizer"),l=e("utils/date/DateParser"),c=e("utils/date/DateFormatter"),h=e("utils/NavigationUtil"),p=e("views/sleep/SleepMovementChartView"),d=e("widgets/sleep/views/SleepTimeDemoView"),v=e("widgets/sleep/views/SleepTimeEditView"),m=e("text!widgets/sleep/templates/SleepMovement.html"),g=e("text!widgets/sleep/templates/noData.html"),y=e("jquerymenus");return i.extend({name:"sleepMovement",titleKeyName:"title_sleep_widget",menuKeyName:"sleep_movement",stateClassName:"widget-large sleep",templateHtml:m,noDataTemplateHtml:g,headerUrl:function(){var e=new Date,t=c.formatISODate(e);return"/daily-summary/"+this.getDisplayName()+"/"+t+"/sleep"},applicationEvents:{SLEEP_WINDOW_CHANGED:"onSleepWindowChanged"},initializeWidgetState:function(){this.sleeps=new u([],{startIndex:1,limit:10}),this.mergedSummaries=new a([],{displayName:this.getDisplayName(),startIndex:1,limit:10})},maxPage:function(){return this.sleeps.hasMoreMembers()?9999:this.sleeps.length-1},numLoadedPages:function(){return this.sleeps.length},provideModels:function(e){if(this.sleeps.length===0)return{classIconName:"icon-sleep"};this.mergedSummary=this.mergedSummaries.at(e),this.isToday=this.mergedSummary.isToday(),this.dailySleep=this.sleeps.findSleepByDate(this.mergedSummary.get("calendarDate")),this.dailySleep||(this.dailySleep=new s({calendarDate:this.mergedSummary.get("calendarDate")}));var t=null;if(this.mergedSummary){var n=this.mergedSummary.get("lastSyncTimestampGMT");t=n!==null?l.parseISOUTC(n).getTime():null}return{displayName:this.getDisplayName(),classIconName:"icon-sleep",calendarDate:c.formatFriendlyDate(l.parseISO(this.mergedSummary.get("calendarDate"))),mergedSummary:this.mergedSummary?this.mergedSummary.toJSON():{},syncDate:t,isToday:this.isToday,url:h.url}},fetchMore:function(){var e=new f;e.addModel({model:this.sleeps,required:!0}),e.addModel({model:this.mergedSummaries,required:!0});var t=this;e.bind(f.Events.SYNCHRONIZED,function(){t.fetchMoreComplete()},this),e.fetchModels()},provideDependencies:function(e){e.addModel({model:this.mergedSummaries,required:!0}),e.addModel({model:this.sleeps,required:!0})},formatFooter:function(e){return c.formatFriendlyDate(l.parseISO(this.mergedSummary.get("calendarDate")),"short")},postRender:function(){if(this.sleeps.length===0)return;(!this.dailySleep||!this.dailySleep.getSleepWindowConfirmed())&&this.onEditSleepTimeClicked(),this.fetchDailySleepData()},fetchDailySleepData:function(){var e=new f;this.dailySleep.getSleepTimeSeconds()<3600?this.buffer=this.dailySleep.getSleepTimeSeconds()/60:this.buffer=60,this.dailySleepData=new o({calendarDate:this.dailySleep.getCalendarDate()}),this.dailySleepData.setDisplayName(this.getDisplayName()),this.dailySleepData.setBuffer(this.buffer),e.addModel({model:this.dailySleepData,required:!0}),this.listenTo(e,f.Events.SYNCHRONIZED,function(){this.renderWidget()}),this.listenTo(e,f.Events.SYNCHRONIZE_FAILED,function(){this.widgetView.onDependenciesLoadFailed()}),e.fetchModels()},renderWidget:function(){this.renderSleepTimeDemoView(),this.displaySleepChart()},renderSleepTimeDemoView:function(){this.sleepTimeDemoView&&this.sleepTimeDemoView.off(),this.sleepTimeDemoView=new d({el:this.$(".sleep-time-container"),dailySleep:this.dailySleep,userPreferences:this.userPreferences}),this.sleepTimeDemoView.on(d.Events.EDIT,this.onEditSleepTimeClicked,this),this.sleepTimeDemoView.render()},onSleepTimeChanged:function(){this.raiseApplicationEvent(r.SLEEP_WINDOW_CHANGED,this.dailySleep)},onSleepWindowChanged:function(e,t){t&&(t.getCalendarDate()===this.dailySleep.getCalendarDate()?(this.dailySleep=t,this.fetchDailySleepData(),this.closeWidgetSheet()):this.replaceSleepModel(t))},onEditSleepTimeClicked:function(){var e=new v({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,userPreferences:this.userPreferences,viewTemplate:"widget"});e.on(v.Events.CHANGE,this.onSleepTimeChanged,this),this.displaySheet(e,null,"widget-sheet widget-sheet-bottom widget-sheet-prev-results allow-overflow")},displaySleepChart:function(){if(!this.dailySleepData)throw"Daily Sleep Data is required";this.timeFormat24Hour=this.userPreferences.is24HourFormat();if(!this.getHasSleepData()){this.renderNoSleepData();return}this.renderSleepMovementChartView()},getHasSleepData:function(){return this.dailySleep&&this.dailySleep.getSleepTimeSeconds()},renderNoSleepData:function(){var e=t.template(g);this.$(".sleep-movement-chart-placeholder").html(e({Localizer:n}))},renderSleepMovementChartView:function(){this.sleepMovementChartView=new p({el:this.$(".sleep-movement-chart-placeholder"),size:"SMALL",sleepMovement:this.dailySleepData.getSleepMovement(),dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,timeFormat24Hour:this.timeFormat24Hour,userPreferences:this.userPreferences,buffer:this.buffer,isManuallyEnteredSleep:this.dailySleep.getIsManuallyEnteredSleep(),isUnmeasurableSleep:this.dailySleep.getIsUnmeasurableSleep()}),this.sleepMovementChartView.render()},replaceSleepModel:function(e){for(var t=0;t<this.sleeps.length;t++)if(this.sleeps.at(t).getCalendarDate()===e.getCalendarDate()){this.sleeps.remove(this.sleeps.at(t)),this.sleeps.add(e,{at:t});break}}})}),define("text!templates/sleep/SleepDonutHoleView.html",[],function(){return'<div class="donut-center">\n    <% if(isUnmeasurableSleep) { %>\n    <span class="data-label truncate" title="<%= Localizer.localize(\'stress_type_unmeasurable\') %>"><%= Localizer.localize(\'stress_type_unmeasurable\') %></span>\n    <% } else { %>\n    <div class="data-bit"><%= sleepTime %></div>\n    <span class="data-label truncate" title="<%= Localizer.localize(\'wellness_sleep_total_sleep\') %>"><%= Localizer.localize(\'wellness_sleep_total_sleep\') %></span>\n    <% } %>\n\n    <span class="data-label truncate top-xs" title="<%~ Localizer.localize(\'sleep_goal\', goalTime) %>"><%~ Localizer.localize(\'sleep_goal\', goalTime) %></span>\n\n    <div class="goal-checkmark <% goalMet ? print(\'goal-met\') : \'\' %>"><i class="icon-checkmark"></i></div>\n</div>\n\n'}),define("views/sleep/SleepDonutChartView",["require","underscore","backbone","localizer","utils/date/TimeUtil","text!templates/sleep/SleepDonutHoleView.html"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("utils/date/TimeUtil"),s=e("text!templates/sleep/SleepDonutHoleView.html"),o=n.View.extend({PIE_SLICES:{DEEP_SLEEP:{color:"rgba(12, 122, 171, 1)"},LIGHT_SLEEP:{color:"rgba(17, 169, 237, 1)"},REM_SLEEP:{color:"rgba(121, 62, 172, 1)"},AWAKE:{color:"rgba(223, 110, 205, 1)"},MANUALLY_ENTERED:{color:"rgba(100, 175, 205, 1)"},UNMEASURABLE:{color:"rgba(126, 126, 126, 1)"}},initialize:function(e){this.mergedSummary=e.mergedSummary,this.sleepTimeSeconds=e.sleepTimeSeconds,this.sleepTypeDurations=e.sleepTypeDurations,this.isManuallyEnteredSleep=e.isManuallyEnteredSleep,this.isUnmeasurableSleep=e.isUnmeasurableSleep||!e.sleepTypeDurations,this.isRemCapable=e.isRemCapable,this.backgroundColor=e.backgroundColor||"#fff"},remove:function(){return this.$el.off(),n.View.prototype.remove()},render:function(){Highcharts.setOptions({global:{useUTC:!1}});var e=this.getDataAndColors(),t={chart:{plotBackgroundColor:this.backgroundColor,plotBorderWidth:null,plotShadow:!1,height:this.isRemCapable?230:255,width:290,renderTo:this.el,backgroundColor:this.backgroundColor,spacingLeft:0,className:"sleep-donut"},title:{text:this.getDonutHole(),verticalAlign:"middle",useHTML:!0,y:-43},tooltip:!1,plotOptions:{pie:{dataLabels:!1,states:{hover:!1},startAngle:-60,endAngle:300,size:"100%",center:["50%","50%"],borderWidth:this.isManuallyEnteredSleep||this.isUnmeasurableSleep?0:1,slicedOffset:1}},series:[{type:"pie",innerSize:"55%",data:e}],credits:{enabled:!1},exporting:{enabled:!1}};this.chart=new Highcharts.Chart(t)},getDataAndColors:function(){return this.isManuallyEnteredSleep?this.getManuallyEnteredDataState():this.isUnmeasurableSleep?this.getUnmeasurableDataState():this.getNormalDataState()},getManuallyEnteredDataState:function(){var e=[];return e.push(this.buildPoint("MANUALLY_ENTERED",100,100)),e},getUnmeasurableDataState:function(){var e=[];return e.push(this.buildPoint("UNMEASURABLE",100,100)),e},getNormalDataState:function(){var e=[],t=this.sleepTypeDurations.unmeasurableSleep,n=this.sleepTypeDurations.deepSleep,r=this.sleepTypeDurations.lightSleep,i=this.sleepTypeDurations.remSleep,s=this.sleepTypeDurations.awake,o=t+n+r+i+s;return e.push(this.buildPoint("DEEP_SLEEP",n,o)),e.push(this.buildPoint("LIGHT_SLEEP",r,o)),this.isRemCapable&&e.push(this.buildPoint("REM_SLEEP",i,o)),e.push(this.buildPoint("AWAKE",s,o)),e.push(this.buildPoint("UNMEASURABLE",t,o)),e},buildPoint:function(e,t,n){var r=this.PIE_SLICES[e];return r.y=t/n*100,r},getDonutHole:function(){var e=i.formatTime24Hour(this.sleepTimeSeconds),n=28800,o=i.formatTime24Hour(n),u=this.sleepTimeSeconds>=n&&!this.isUnmeasurableSleep,a=t.template(s)({Localizer:r,sleepTime:e,goalTime:o,goalMet:u,isUnmeasurableSleep:this.isUnmeasurableSleep});return a}});return o}),define("utils/sleep/SleepUtil",["require","utils/date/DateParser"],function(e){var t=e("utils/date/DateParser"),n={getTotalSleepTypeDurations:function(e){var n=e.sleepLevelsData,r=e.isRemCapable,i=t.parseISOUTC(e.sleepStartTimestampGMT),s=t.parseISOUTC(e.sleepEndTimestampGMT),o,u,a,f,l={unmeasurableSleep:0,deepSleep:0,lightSleep:0,remSleep:0,awake:0};if(n.length<=0)return!1;for(var c=0,h=n.length;c<h;c++){o=n[c],u=t.parseISOUTC(o.startGMT),a=t.parseISOUTC(o.endGMT);if(u.getTime()<i.getTime()||a.getTime()>s.getTime())continue;f=this.calculateDuration(u,a)/1e3,r?o.activityLevel===-1?l.unmeasurableSleep+=f:o.activityLevel===0?l.deepSleep+=f:o.activityLevel===1?l.lightSleep+=f:o.activityLevel===2?l.remSleep+=f:o.activityLevel===3&&(l.awake+=f):o.activityLevel===0?l.deepSleep+=f:o.activityLevel===1?l.lightSleep+=f:l.awake+=f}return l},calculateDuration:function(e,t){return e&&t?t.getTime()-e.getTime():0}};return n}),define("text!templates/sleep/SleepDurationsView.html",[],function(){return'<% if(context === \'widget\') { %>\n\n    <% if(isRemCapable) { %>\n\n    <div class="data-bits data-types">\n        <div class="data-1">\n            <h5 class="data-bit color-24 truncate" title="<%= deepDuration %>"><%= deepDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'deep\') %>"><%= Localizer.localize(\'deep\') %></span>\n        </div>\n        <div class="data-1">\n            <h5 class="data-bit color-229 truncate" title="<%= remDuration %>"><%= remDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'rem\') %>"><%= Localizer.localize(\'rem\') %></span>\n        </div>\n    </div>\n    <div class="data-bits data-types">\n        <div class="data-1">\n            <div class="h5 data-bit color-21 truncate" title="<%= lightDuration %>"><%= lightDuration %></div>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'light\') %>"><%= Localizer.localize(\'light\') %></span>\n        </div>\n        <div class="data-1">\n            <h5 class="data-bit color-63 truncate" title="<%= awakeDuration %>"><%= awakeDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'awake\') %>"><%= Localizer.localize(\'awake\') %></span>\n        </div>\n    </div>\n\n    <% } else { %>\n\n    <div class="data-bits data-types not-rem-capable">\n        <div class="data-1">\n            <h5 class="data-bit color-24 truncate" title="<%= deepDuration %>"><%= deepDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'deep\') %>"><%= Localizer.localize(\'deep\') %></span>\n        </div>\n        <div class="data-1">\n            <h5 class="data-bit color-21 truncate" title="<%= lightDuration %>"><%= lightDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'light\') %>"><%= Localizer.localize(\'light\') %></span>\n        </div>\n        <div class="data-1">\n            <h5 class="data-bit color-63 truncate" title="<%= awakeDuration %>"><%= awakeDuration %></h5>\n            <span class="data-label truncate" title="<%= Localizer.localize(\'awake\') %>"><%= Localizer.localize(\'awake\') %></span>\n        </div>\n    </div>\n\n    <% } %>\n\n<% } else { %>\n\n    <div class="data-block large">\n        <div class="data-bit color-24 truncate" title="<%= deepDuration %>"><%= deepDuration %></div>\n        <span class="data-label truncate" title="<%= Localizer.localize(\'deep\') %>"><%= Localizer.localize(\'deep\') %></span>\n    </div>\n    <div class="data-block large">\n        <div class="data-bit color-21 truncate" title="<%= lightDuration %>"><%= lightDuration %></div>\n        <span class="data-label truncate" title="<%= Localizer.localize(\'light\') %>"><%= Localizer.localize(\'light\') %></span>\n    </div>\n\n    <% if(isRemCapable) { %>\n    <div class="data-block large">\n        <div class="data-bit color-229 truncate" title="<%= remDuration %>"><%= remDuration %></div>\n        <span class="data-label truncate" title="<%= Localizer.localize(\'rem\') %>"><%= Localizer.localize(\'rem\') %></span>\n    </div>\n    <% } %>\n\n    <div class="data-block large bottom-none">\n        <div class="data-bit color-63 truncate" title="<%= awakeDuration %>"><%= awakeDuration %></div>\n        <span class="data-label truncate" title="<%= Localizer.localize(\'awake\') %>"><%= Localizer.localize(\'awake\') %></span>\n    </div>\n\n<% } %>'}),define("views/sleep/SleepDurationsView",["require","underscore","backbone","localizer","utils/sleep/SleepUtil","utils/date/TimeUtil","text!templates/sleep/SleepDurationsView.html"],function(e){var t=e("underscore"),n=e("backbone"),r=e("localizer"),i=e("utils/sleep/SleepUtil"),s=e("utils/date/TimeUtil"),o=e("text!templates/sleep/SleepDurationsView.html"),u=n.View.extend({template:t.template(o),initialize:function(e){this.context=e.context,this.mergedSummary=e.mergedSummary,this.sleepTypeDurations=e.sleepTypeDurations,this.isManuallyEnteredSleep=e.isManuallyEnteredSleep,this.isUnmeasurableSleep=e.isUnmeasurableSleep||!e.sleepTypeDurations,this.isRemCapable=e.isRemCapable;if(!this.context||this.context!=="widget"&&this.context!=="page")throw"Context parameter is required"},render:function(){this.isManuallyEnteredSleep||this.isUnmeasurableSleep?this.$el.html(this.template({Localizer:r,context:this.context,deepDuration:"--",lightDuration:"--",remDuration:"--",awakeDuration:"--",isRemCapable:this.isRemCapable})):this.$el.html(this.template({Localizer:r,context:this.context,deepDuration:this.formatDuration(this.sleepTypeDurations.deepSleep),lightDuration:this.formatDuration(this.sleepTypeDurations.lightSleep),remDuration:this.formatDuration(this.sleepTypeDurations.remSleep),awakeDuration:this.formatDuration(this.sleepTypeDurations.awake),isRemCapable:this.isRemCapable}))},formatDuration:function(e){var t=s.secondsToTime(e);return t.h!==0?t.h+r.localize("duration_hour_short")+" "+t.m+r.localize("duration_minute"):t.m!==0?t.m+r.localize("duration_minute"):"--"}});return u}),define("text!widgets/sleep/templates/SleepSummary.html",[],function(){return'<% var dailyLink = url(\'/daily-summary/\' + displayName + \'/\' + mergedSummary.calendarDate + \'/sleep\'); %>\n\n<div class="data-1 bottom-xs">\n    <h3 class="data-bit"><a href="<%= dailyLink %>" class="daily-sleep-link"><%= calendarDate %></a></h3>\n    <span class="data-label">\n        <% if (syncDate && isToday) { %>\n            <%= Localizer.localize(\'step_summary_synced\') %> <%= syncDate ? Personalizer.personalizeDateAndTime(syncDate, Localizer) : \'\' %>\n        <% } else if(isToday) { %>\n            <%= Localizer.localize(\'step_summary_not_synced\') %>\n        <% } %>\n    </span>\n    <div class="sleep-time-container"></div>\n</div>\n\n<div class="centered sleep-donut-container bottom-s">\n    <div class="sleep-donut-chart-view">\n        <!-- Sleep donut chart goes here -->\n    </div>\n\n    <div class="sleep-durations-view">\n        <!-- Sleep durations goes here -->\n    </div>\n</div>'}),define("widgets/sleep/states/SleepSummaryState",["require","underscore","localizer","moment","constants/main/ApplicationEvents","views/main/WidgetStateView","models/sleep/DailySleep","models/sleep/DailySleepData","models/system/SystemPreference","models/user/ViewerSocialProfile","collections/sleep/Sleeps","collections/wellness/MergedSummaries","views/sleep/SleepDonutChartView","views/sleep/SleepDurationsView","widgets/sleep/views/SleepTimeEditView","widgets/sleep/views/SleepTimeDemoView","utils/ModelSynchronizer","utils/sleep/SleepUtil","utils/date/DateFormatter","utils/date/DateParser","utils/NavigationUtil","text!widgets/sleep/templates/SleepSummary.html","text!widgets/sleep/templates/noData.html"],function(e){var t=e("underscore"),n=e("localizer"),r=e("moment"),i=e("constants/main/ApplicationEvents"),s=e("views/main/WidgetStateView"),o=e("models/sleep/DailySleep"),u=e("models/sleep/DailySleepData"),a=e("models/system/SystemPreference"),f=e("models/user/ViewerSocialProfile"),l=e("collections/sleep/Sleeps"),c=e("collections/wellness/MergedSummaries"),h=e("views/sleep/SleepDonutChartView"),p=e("views/sleep/SleepDurationsView"),d=e("widgets/sleep/views/SleepTimeEditView"),v=e("widgets/sleep/views/SleepTimeDemoView"),m=e("utils/ModelSynchronizer"),g=e("utils/sleep/SleepUtil"),y=e("utils/date/DateFormatter"),b=e("utils/date/DateParser"),w=e("utils/NavigationUtil"),E=e("text!widgets/sleep/templates/SleepSummary.html"),S=e("text!widgets/sleep/templates/noData.html");return s.extend({name:"sleepSummary",titleKeyName:"title_sleep_widget",menuKeyName:"sleep_summary",stateClassName:"widget-large sleep",templateHtml:E,noDataTemplateHtml:S,headerUrl:function(){var e=new Date,t=y.formatISODate(e);return"/daily-summary/"+this.getDisplayName()+"/"+t+"/sleep"},applicationEvents:{SLEEP_WINDOW_CHANGED:"onSleepWindowChanged"},initializeWidgetState:function(){this.sleeps=new l([],{startIndex:1,limit:10}),this.mergedSummaries=new c([],{displayName:this.getDisplayName(),startIndex:1,limit:10}),this.remSleepEnabledPreference=new a({preferenceKey:"REMSleep.enabled"})},provideDependencies:function(e){e.addModel({model:this.mergedSummaries,required:!0}),e.addModel({model:this.sleeps,required:!0}),e.addModel({model:this.remSleepEnabledPreference,required:!0})},provideModels:function(e){if(this.sleeps.length===0)return{classIconName:"icon-sleep"};this.mergedSummary=this.mergedSummaries.at(e),this.isToday=this.mergedSummary.isToday(),this.dailySleep=this.sleeps.findSleepByDate(this.mergedSummary.get("calendarDate")),this.dailySleep||(this.dailySleep=new o({calendarDate:this.mergedSummary.get("calendarDate")}));var t=null;if(this.mergedSummary){var n=this.mergedSummary.get("lastSyncTimestampGMT");t=n!==null?b.parseISOUTC(n).getTime():null}return{displayName:this.getDisplayName(),classIconName:"icon-sleep",calendarDate:y.formatFriendlyDate(b.parseISO(this.mergedSummary.get("calendarDate"))),mergedSummary:this.mergedSummary?this.mergedSummary.toJSON():{},syncDate:t,isToday:this.isToday,url:w.url}},maxPage:function(){return this.mergedSummaries.hasMoreMembers()?9999:this.mergedSummaries.length-1},numLoadedPages:function(){return this.mergedSummaries.length},postRender:function(){if(this.sleeps.length===0)return;(!this.dailySleep||!this.dailySleep.getSleepWindowConfirmed())&&this.onEditSleepTimeClicked(),this.fetchDailySleepData()},fetchDailySleepData:function(){var e=new m;this.dailySleepData=new u({calendarDate:this.mergedSummary.get("calendarDate")}),this.dailySleepData.setDisplayName(this.getDisplayName()),this.dailySleepData.setBuffer(60),e.addModel({model:this.dailySleepData,required:!0,countError:!0}),this.listenTo(e,m.Events.SYNCHRONIZED,function(){this.renderSleepSummary()}),this.listenTo(e,m.Events.SYNCHRONIZE_FAILED,function(){this.widgetView.onDependenciesLoadFailed()}),e.fetchModels()},renderSleepSummary:function(){var e=this.getHasSleepData();e?(this.isRemCapable=this.dailySleepData.getRemSleepData()&&this.getIsRemEnabled(),this.renderTotalSleepTimeView(),this.renderSleepDonut(),this.renderSleepDurationsView()):this.renderNoSleepData()},getIsRemEnabled:function(){var e=f.hasMBTesterRole(),t=this.remSleepEnabledPreference.get("value")==="true";return e||t},getHasSleepData:function(){return this.dailySleep&&this.dailySleep.getSleepTimeSeconds()},renderTotalSleepTimeView:function(){this.sleepTimeDemoView&&this.sleepTimeDemoView.off(),this.sleepTimeDemoView=new v({el:this.$(".sleep-time-container"),dailySleep:this.dailySleep,userPreferences:this.userPreferences}),this.listenTo(this.sleepTimeDemoView,v.Events.EDIT,this.onEditSleepTimeClicked),this.sleepTimeDemoView.render()},renderSleepDonut:function(){this.sleepDonutChartView=new h({el:this.$(".sleep-donut-chart-view"),mergedSummary:this.mergedSummary,sleepTimeSeconds:this.dailySleep.getSleepTimeSeconds(),sleepTypeDurations:this.getSleepTypeDurations(),isManuallyEnteredSleep:this.dailySleep.getIsManuallyEnteredSleep(),isUnmeasurableSleep:this.dailySleep.getIsUnmeasurableSleep(),isRemCapable:this.isRemCapable}),this.sleepDonutChartView.render()},renderSleepDurationsView:function(){this.sleepDurationsView=new p({el:this.$(".sleep-durations-view"),context:"widget",mergedSummary:this.mergedSummary,sleepTypeDurations:this.getSleepTypeDurations(),isManuallyEnteredSleep:this.dailySleep.getIsManuallyEnteredSleep(),isUnmeasurableSleep:this.dailySleep.getIsUnmeasurableSleep(),isRemCapable:this.isRemCapable}),this.sleepDurationsView.render()},onSleepTimeChanged:function(){this.raiseApplicationEvent(i.SLEEP_WINDOW_CHANGED,this.dailySleep)},onSleepWindowChanged:function(e,t){t&&(t.getCalendarDate()===this.dailySleep.getCalendarDate()?(this.dailySleep=t,this.fetchDailySleepData(),this.closeWidgetSheet()):this.replaceSleepModel(t))},onEditSleepTimeClicked:function(){var e=new d({dailySleep:this.dailySleep,mergedSummary:this.mergedSummary,userPreferences:this.userPreferences,viewTemplate:"widget"});this.listenTo(e,d.Events.CHANGE,this.onSleepTimeChanged),this.displaySheet(e,null,"widget-sheet widget-sheet-bottom widget-sheet-prev-results allow-overflow")},getSleepTypeDurations:function(){return g.getTotalSleepTypeDurations({sleepLevelsData:this.dailySleepData.getSleepLevels(),sleepStartTimestampGMT:this.dailySleep.getSleepStartTimestampGMT()?this.dailySleep.getSleepStartTimestampGMT():this.dailySleep.getAutoSleepStartTimestampGMT(),sleepEndTimestampGMT:this.dailySleep.getSleepEndTimestampGMT()?this.dailySleep.getSleepEndTimestampGMT():this.dailySleep.getAutoSleepEndTimestampGMT(),isRemCapable:this.isRemCapable})},fetchMore:function(){var e=this,t=new m;t.addModel({model:this.sleeps,required:!0}),t.addModel({model:this.mergedSummaries,required:!0}),t.addModel({model:this.remSleepEnabledPreference,required:!0}),t.bind(m.Events.SYNCHRONIZED,function(){e.fetchMoreComplete()},this),t.fetchModels()},formatFooter:function(e){return y.formatFriendlyDate(r(this.mergedSummary.get("calendarDate")).toDate(),!0)},renderNoSleepData:function(){var e=t.template(S);this.$(".sleep-donut-container").html(e({Localizer:n}))},replaceSleepModel:function(e){for(var t=0;t<this.sleeps.length;t++)if(this.sleeps.at(t).getCalendarDate()===e.getCalendarDate()){this.sleeps.remove(this.sleeps.at(t)),this.sleeps.add(e,{at:t});break}}})}),define("widgets/sleep/states/SmallState",["require","views/main/WidgetStateView","utils/date/DateFormatter","text!templates/main/Widget/SmallWidgetContent.html"],function(e){var t=e("views/main/WidgetStateView"),n=e("utils/date/DateFormatter"),r=e("text!templates/main/Widget/SmallWidgetContent.html"),i=t.extend({name:"sleepLevels",titleKeyName:"title_sleep_widget",menuKeyName:"title_widget_small",headerUrl:function(){var e=new Date,t=n.formatISODate(e),r="/daily-summary/"+this.getDisplayName()+"/"+t+"/sleep";return r},stateClassName:"widget widget-small sleep",templateHtml:r,noDataTemplateHtml:r,showFooter:!1,showHeaderTitle:!1,maxPage:function(){return 0},numLoadedPages:function(){return 1},provideModels:function(){return{classIconName:"icon-sleep"}}});return i}),define("widgets/sleep/SleepDemo",["require","views/main/WidgetView","widgets/sleep/states/SleepLevelsState","widgets/sleep/states/SleepMovementState","widgets/sleep/states/SleepSummaryState","widgets/sleep/states/SmallState"],function(e){var t=e("views/main/WidgetView"),n=e("widgets/sleep/states/SleepLevelsState"),r=e("widgets/sleep/states/SleepMovementState"),i=e("widgets/sleep/states/SleepSummaryState"),s=e("widgets/sleep/states/SmallState");return t.extend({viewStates:[{name:"large-state",views:[{name:"sleepSummary",widgetStateView:i},{name:"sleepLevels",widgetStateView:n},{name:"sleepMovement",widgetStateView:r}]},{name:"small-state",views:[{name:"sleepLevels",widgetStateView:s}]}],propertyFiles:["/main/js/properties/sleep/sleep","/main/js/properties/stress/stress","/main/js/properties/step_summary/step_summary","/main/js/properties/wellness/wellness","/main/js/properties/daily_summary/daily_summary"]})});