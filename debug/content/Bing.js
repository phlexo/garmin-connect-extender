L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(e,t){L.Util.setOptions(this,t),this._key=e,this._url=null,this._providers=[],this.metaRequested=!1},tile2quad:function(e,t,n){var r="";for(var i=n;i>0;i--){var s=0,o=1<<i-1;(e&o)!==0&&(s+=1),(t&o)!==0&&(s+=2),r+=s}return r},getTileUrl:function(e){var t=this._getZoomForUrl(),n=this.options.subdomains,r=this.options.subdomains[Math.abs((e.x+e.y)%n.length)];return this._url.replace("{subdomain}",r).replace("{quadkey}",this.tile2quad(e.x,e.y,t)).replace("{culture}",this.options.culture)},loadMetadata:function(){if(this.metaRequested)return;this.metaRequested=!0;var e=this,t="_bing_metadata_"+L.Util.stamp(this);window[t]=function(n){window[t]=undefined;var r=document.getElementById(t);r.parentNode.removeChild(r);if(n.errorDetails)throw new Error(n.errorDetails);e.initMetadata(n)};var n=document.location.protocol==="file:"?"http":document.location.protocol.slice(0,-1),r=n+"://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+t+"&key="+this._key+"&UriScheme="+n,i=document.createElement("script");i.type="text/javascript",i.src=r,i.id=t,document.getElementsByTagName("head")[0].appendChild(i)},initMetadata:function(e){var t=e.resourceSets[0].resources[0];this.options.subdomains=t.imageUrlSubdomains,this._url=t.imageUrl;if(t.imageryProviders)for(var n=0;n<t.imageryProviders.length;n++){var r=t.imageryProviders[n];for(var i=0;i<r.coverageAreas.length;i++){var s=r.coverageAreas[i],o={zoomMin:s.zoomMin,zoomMax:s.zoomMax,active:!1},u=new L.LatLngBounds(new L.LatLng(s.bbox[0]+.01,s.bbox[1]+.01),new L.LatLng(s.bbox[2]-.01,s.bbox[3]-.01));o.bounds=u,o.attrib=r.attribution,this._providers.push(o)}}this._update()},_update:function(){if(this._url===null||!this._map)return;this._update_attribution(),L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var e=L.latLngBounds(this._map.getBounds().getSouthWest().wrap(),this._map.getBounds().getNorthEast().wrap()),t=this._map.getZoom();for(var n=0;n<this._providers.length;n++){var r=this._providers[n];t<=r.zoomMax&&t>=r.zoomMin&&e.intersects(r.bounds)?(!r.active&&this._map.attributionControl&&this._map.attributionControl.addAttribution(r.attrib),r.active=!0):(r.active&&this._map.attributionControl&&this._map.attributionControl.removeAttribution(r.attrib),r.active=!1)}},onAdd:function(e){this.loadMetadata(),L.TileLayer.prototype.onAdd.apply(this,[e])},onRemove:function(e){for(var t=0;t<this._providers.length;t++){var n=this._providers[t];n.active&&this._map.attributionControl&&(this._map.attributionControl.removeAttribution(n.attrib),n.active=!1)}L.TileLayer.prototype.onRemove.apply(this,[e])}}),L.bingLayer=function(e,t){return new L.BingLayer(e,t)};